<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=0.75">
        <title>Pathfinder web character sheet</title>
        <!--script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script>-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.30.8/react-bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/recompose/0.23.1/Recompose.min.js" integrity="sha256-XDhSiYRiccAHw3isP5XYFAFZXetrB0/7K1WtlhlfoyM=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.24.0/babel.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/6.0.0/normalize.min.css">
        <style>
            .form-group { margin-bottom: 0px; }
            .form-control { padding: 6px 6px; }
            .class-name { width: 20%; }
            .armor-name { width: 40%; }
            .weapon-name { width: 25%; }
            .weapon-bonus { width: 4%; }
            .weapon-damage { width: 12%; }
            .weapon-critical { width: 7%; }
            .weapon-range { width: 8%; }
            .weapon-type { width: 3%; }
            .weapon-weight { width: 3%; }
            .table .ability-base {
                width: 15%;
            }
            .table .skill-name {
                width: 40%;
                text-align: left;
            }
            .table .skill-ability {
                width: 12%;
            }
            .table .hp-temporary {
                min-width: 110px;
            }
            .note-col { padding: 10px 5px 0; }
            #ability-note { min-height: 286px; }
            #save-note { min-height: 171px; }
            #attack-note { min-height: 196px; }
            .table>thead>tr>td, .table>thead>tr>th {
                vertical-align: bottom;
            }
            .table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th {
                vertical-align: middle;
            }
            .table>thead>tr>td,
            .table>tbody>tr>th.success, .table>tbody>tr>td,
            .table>tfoot>tr>td {
                text-align: center;
            }
            .skill-table input, .skill-table select {
                font-size: 100%; /*inherit small*/
                height: 22px;
            }
            .skill-table td.skill-ability {
                padding: 3px;
            }
            .skill-ability select {
                padding: 0;
                -moz-appearance: none;
                -webkit-appearance:none;
            }
            .skill-ability select::-ms-expand {
                display: none;
            }
            .skill-table input[type=checkbox] {
                margin-top: 0;
            }
            .checkbox-inline input[type=text] {
                display: inline;
                width: 70%;
            }
            textarea.autoresize {
                display: block;
                overflow: hidden;
                resize: none;
            }
            @media print {
                body { zoom: 50%; }
                .col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12 {
                    float: left!important;
                }
                .col-sm-12 { width: 100%; }
                .col-sm-11 { width: 91.66666666666666%; }
                .col-sm-10 { width: 83.33333333333334%; }
                .col-sm-9 { width: 75%; }
                .col-sm-8 { width: 66.66666666666666%; }
                .col-sm-7 { width: 58.333333333333336%; }
                .col-sm-6 { width: 50%; }
                .col-sm-5 { width: 41.66666666666667%; }
                .col-sm-4 { width: 33.33333333333333%; }
                .col-sm-3 { width: 25%; }
                .col-sm-2 { width: 16.666666666666664%; }
                .col-sm-1 { width: 8.333333333333332%; }
                .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
                    float: left!important;
                }
                .col-md-12 { width: 100%; }
                .col-md-11 { width: 91.66666666666666%; }
                .col-md-10 { width: 83.33333333333334%; }
                .col-md-9 { width: 75%; }
                .col-md-8 { width: 66.66666666666666%; }
                .col-md-7 { width: 58.333333333333336%; }
                .col-md-6 { width: 50%; }
                .col-md-5 { width: 41.66666666666667%; }
                .col-md-4 { width: 33.33333333333333%; }
                .col-md-3 { width: 25%; }
                .col-md-2 { width: 16.666666666666664%; }
                .col-md-1 { width: 8.333333333333332%; }
            }
        </style>

        <script type="text/babel">
            const { Glyphicon, Grid, Row, Col, Table, Form, Checkbox, FormGroup, FormControl, ControlLabel, ButtonToolbar, Button} = ReactBootstrap;
            const { pure, compose, onlyUpdateForKeys  } = Recompose;
            const STATS = ['STR','DEX','CON', 'INT','WIS','CHA'];
            const STAT_TYPES = ['base','enhance','misc','temp'];
            const CLASSES = ['class1','class2','class3','class4','class5'];
            const CLASS_TYPES = [ 'class', 'hd', 'hp', 'bab', 'skill', 'fort', 'ref', 'will', 'levels' ];

            class App extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {stat:{ size:0 }, prevChangeWasToKey: ''};
                    STATS.map( (stat) => {
                        this.state.stat[stat] = { 'base': 10 };
                    });
                    this.prevHistoryPushWasWithKey;
                    this.isLoading = false;
                    this.fn = {};
                    this.fn.handleChange =  this.handleChange.bind(this);
                    this.fn.getState = this.getState.bind(this);
                    this.fn.getClassTypeTotal = this.getClassTypeTotal.bind(this);
                    this.fn.getAbilityTotal = this.getAbilityTotal.bind(this);
                    this.fn.getAbilityMod = this.getAbilityMod.bind(this);
                    this.fn.getArmorLimitedDex = this.getArmorLimitedDex.bind(this);
                }
                componentDidUpdate(prevProps, prevState) {
                    let result = {};
                    function recurse (cur, prop) {
                        if( typeof(cur) == 'function' ) {
                            // console.debug( 'componentDidUpdate: function', prop);
                        } else if (Object(cur) !== cur) {
                            result[prop] = cur;
                        } else {
                            var isEmpty = true;
                            for (var p in cur) {
                                isEmpty = false;
                                recurse(cur[p], prop ? prop+"."+p : p);
                            }
                            if (isEmpty && prop)
                                result[prop] = {};
                        }
                    }
                    recurse(this.state, "");
                    var qp = "";
                    for (var k in result) {
                        qp += "&" + k + "=" + encodeURIComponent( result[k] );
                    }
                    const title = this.getState(['info','character'])
                        + '(lvl' + this.getClassTypeTotal('levels') + '): '
                        + this.state.prevChangeWasToKey;
                    if( !this.isLoading ) { // push no state while loading
                        if ( ''+this.prevHistoryPushWasWithKey == ''+this.state.prevChangeWasToKey ) {
                            console.debug('history.replaceState', title);
                            history.replaceState(this.state , title, '?' + qp.slice(1).replace( /\%20/g, '+' ));
                        } else {
                            console.debug('history.pushState', title);
                            history.pushState(this.state, title, '?' + qp.slice(1).replace( /\%20/g, '+' ));
                            this.prevHistoryPushWasWithKey = this.state.prevChangeWasToKey;
                        }
                    }
                    document.title = title;
                    // history.pushState('', '', '?state=' + encodeURIComponent( JSON.stringify( this.state )).replace( /\%20/g, '+' ));
                }

                componentWillMount() {
                    function convertKey(k) {
                        if( STATS.indexOf( k.split('.')[0] )>-1 ) return 'stat.'+k;
                        if( k == 'info.size' ) return 'size';
                        return k;
                    }
                    function getQueryParams(qs) {
                        qs = qs.split('+').join(' ');
                        var params = {}, tokens, re = /[?&]?([^=]+)=([^&]*)/g;
                        while (tokens = re.exec(qs)) {
                            params[ convertKey( decodeURIComponent(tokens[1]) ) ] =
                                decodeURIComponent(tokens[2]);
                        }
                        return params;
                    }
                    const queryParams = getQueryParams(window.location.search);
                    if ( queryParams.state ) {
                        // depracated old state format
                        let s = JSON.parse( queryParams.state );
                        console.info( 'componentWillMount: restoring state:', s );
                        this.isLoading = false;
                        this.setState( s );
                    } else {
                        this.isLoading = true;
                        this.setState( (ps, pp) => {
                            for( var k in queryParams ) {
                                    this.setStateByKey( k.split('.'), queryParams[k] );
                            }
                            console.info( 'componentWillMount: restored state:', this.state );
                        });
                    }
                    setTimeout( () => {
                        console.debug('loading complete');
                        this.state.prevChangeWasToKey = ["url loaded"];
                        this.componentDidUpdate( null, null );
                        this.isLoading = false;
                    }, 1000);
                }

                restoreState(event) {
                    console.log( 'popstate: restoring state', event.state );
                    this.isLoading = true;
                    this.setState( event.state );
                    this.forceUpdate();
                    this.isLoading = false;
                    console.debug('state restored:', this.state );
                }

                componentDidMount() {
                    window.onpopstate = event => this.restoreState(event);
                }

                withPropKeyValue( prevState, propKey, newVal ) {
                    newVal = (newVal == parseFloat(newVal)) ? parseFloat(newVal) : newVal;
                    const newState = {};
                    let newLeaf = newState;
                    let leaf = propKey.slice(0,-1).reduce(
                        ( childState, key ) => {
                            if( childState[key] === undefined ) {
                                return newLeaf = newLeaf[key] = {};
                            }
                            newLeaf = newLeaf[key] = {...childState[key]};
                            return childState[key];
                        }, prevState );
                    const oldVal = leaf[propKey[propKey.length-1]];
                    newLeaf[propKey[propKey.length-1]] = newVal;
                    if (newVal === undefined) {
                        delete newLeaf[propKey[propKey.length-1]];
                    }
                    //console.debug('with', propKey, newLeaf, newState, 'was', oldVal);
                    return newState;
                }
                setStateByKey( propKey, newVal ) {
                    this.setState( (prevState, setProps) => {
                        const newState = this.withPropKeyValue( prevState, propKey, newVal );
                        newState.prevChangeWasToKey = propKey;
                        //console.log('setState', newState, propKey, newVal, 'of', prevState, setProps);
                        return newState;
                    } );
                }
                handleChange(propKey) {
                    return (e) => {
                        const evval = e.target.type === 'checkbox' ? e.target.checked
                            : e.target.value;
                        const newVal =
                            typeof(evval)==='boolean' ? evval || undefined :
                            evval.length==0 ? undefined :
                            !isNaN(Number(evval)) ? Number(evval) :
                            evval;
                        // console.log('handleChange event', propKey, newVal, evval, e.target);
                        this.setStateByKey( propKey, newVal );
                    };
                }
                getState(propKey, defaultTo) {
                    return propKey.reduce((tree, key) =>
                        typeof tree == 'object' && key in tree ? tree[key] : defaultTo, this.state );
                }
                getClassTypeTotal(type) {
                    return CLASSES.reduce( (sum, classN) =>
                        ( sum+parseFloat('0'+this.getState([classN,type]))), 0)
                }
                getAbilityTotal(ability) {
                    if (STATS.indexOf(ability) == -1) return NaN;
                    return STAT_TYPES.reduce(
                        (sum,type) =>
                            sum + parseInt(this.getState(['stat',ability,type])||0), 0);
                }
                getAbilityMod(ability) {
                    return Math.round((this.getAbilityTotal(ability)-11)/2);
                }
                getArmorLimitedDex() {
                    return Math.min(
                        this.getAbilityMod('DEX'),
                        this.getState(['armor','max-dex'], Infinity),
                        this.getState(['shield','max-dex'], Infinity));
                }
                render() {
                    return (
                    <Grid fluid>
                    <Form>
                        <InfoRow {...this.fn} />
                        <Row>
                        <Col md={5}>
                        <Row>
                            <Col xs={8} sm={9}>
                                <AbilityTable {...this.fn} {...this.state} />
                            </Col>
                            <Col xs={4} sm={3} className="note-col">
                                <NoteArea {...this.fn} noteKey="ability" />
                            </Col>
                        </Row>
                        </Col>
                        <Col md={7}>
                        <Table condensed>
                            <thead>
                                <tr>
                                    <th className="class-name"><small>Classname</small></th>
                                    <th><small>HD</small></th>
                                    <th><small>HP</small></th>
                                    <th><small>BAB</small></th>
                                    <th><small>Skill</small></th>
                                    <th><small>FORT</small></th>
                                    <th><small>REF</small></th>
                                    <th><small>WILL</small></th>
                                    <th><small>Levels</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                <ClassRow {...this.fn} name="class1" />
                                <ClassRow {...this.fn} name="class2" />
                                <ClassRow {...this.fn} name="class3" />
                                <ClassRow {...this.fn} name="class4" />
                                <ClassRow {...this.fn} name="class5" />
                                <tr>
                                    <th>Base totals</th>
                                    <td></td>
                                    <td>{this.getClassTypeTotal('hp')}</td>
                                    <td>{this.getClassTypeTotal('bab')}</td>
                                    <td>{this.getClassTypeTotal('skill')}</td>
                                    <td>{this.getClassTypeTotal('fort')}</td>
                                    <td>{this.getClassTypeTotal('ref')}</td>
                                    <td>{this.getClassTypeTotal('will')}</td>
                                    <td>{this.getClassTypeTotal('levels')}</td>
                                </tr>
                            </tbody>
                        </Table>
                        </Col>
                        </Row>
                        <Row>
                        <Col md={7}>
                        <SpeedTable {...this.fn}/>
                            <Row>
                            <Col xs={7}>
                                <InitTable {...this.fn}/>
                                <ResistanceTable {...this.fn}/>
                            </Col>
                            <Col xs={5}>
                                <HPTable {...this.fn}/>
                            </Col>
                        </Row>
                        <ACTable {...this.fn} {...this.state}/>
                        <Row>
                            <Col xs={8}>
                                <SaveTable {...this.fn}/>
                            </Col>
                            <Col xs={4} className="note-col">
                                <NoteArea {...this.fn} noteKey="save" />
                            </Col>
                        </Row>
                        <Row>
                            <Col xs={8}>
                                <AttackTable {...this.fn}/>
                            </Col>
                            <Col xs={4} className="note-col">
                                <NoteArea {...this.fn} noteKey="attack" />
                            </Col>
                        </Row>
                        <ArmorTable {...this.fn}/>
                        </Col>
                        <Col md={5}>
                            <SkillTable {...this.fn} {...this.state} />
                        </Col>
                        <Col xs={12}>
                            <WeaponTable {...this.fn}/>
                        </Col>
                        </Row>
                        <Row>
                            <Col sm={12} md={6} className="note-col">
                                <NoteArea {...this.fn} noteKey="feat" />
                            </Col>
                            <Col sm={12} md={6} className="note-col">
                                <NoteArea {...this.fn} noteKey="character" />
                            </Col>
                        </Row>
                        <Row>
                            <Col sm={12} md={6} className="note-col">
                                <NoteArea {...this.fn} noteKey="special" />
                            </Col>
                            <Col sm={12} md={6} className="note-col">
                                <NoteArea {...this.fn} noteKey="equipment" />
                            </Col>
                        </Row>
                    </Form>
                    </Grid>
                    );
                }
            }
        </script>

        <script type="text/babel">
            function InfoField(props) {
                const statePropKey = ['info', props.propKey.toLowerCase()];
                return (
                <Col bsClass="col" xs={props.xs || Math.min(props.sm*2, 12)} sm={props.sm}>
                <FormGroup controlId={statePropKey.join('-')} bsSize="sm">
                <ControlLabel>
                <small>{props.propKey}</small>
                </ControlLabel>
                <FormControl type="text"
                    value={props.getState(statePropKey)}
                    onChange={props.handleChange(statePropKey)}
                />
                </FormGroup>
                </Col>
                );
            }
            function SizeField(props) {
                const sizeValues = [8,4,2,1,0,-1,-2,-4,-8];
                const sizeOptions = ['Fine','Diminutive','Tiny','Small','Medium'
                    ,'Large','Huge','Gargantuan','Colossal'].map( (sizeName,index) =>
                    <option value={sizeValues[index]}>
                        {sizeName+': '+sizeValues[index]}</option> );
                const statePropKey = ['stat', 'size'];
                return (
                <Col bsClass="col" xs={props.xs || Math.min(props.sm*2, 12)} sm={props.sm}>
                <FormGroup controlId={statePropKey.join('-')} bsSize="sm">
                <ControlLabel>
                <small>Size</small>
                </ControlLabel>
                <FormControl componentClass="select"
                    value={props.getState(statePropKey)}
                    onChange={props.handleChange(statePropKey)}>
                        {sizeOptions}
                </FormControl>
                </FormGroup>
                </Col>
                );
            }

            function InfoRow(props) {
                return (
                    <Row>
                    <InfoField {...props} propKey="Character" xs={7} sm={6}/>
                    <InfoField {...props} propKey="Player" xs={3} sm={5}/>
                    <Col xs={2} sm={1}>
                        <div><small>Minify<span className="hidden-xs"> URL</span></small></div>
                        <Button
                            bsStyle="info" target="_blank"
                            href="javascript:window.open('http://www.dy.fi/?c=redir_add&bml=1&url='+encodeURIComponent(location.href), '_blank')">
                            dy.fi</Button>
                    </Col>
                    <InfoField {...props} propKey="Race" sm={2}/>
                    <SizeField {...props} sm={2}/>
                    <InfoField {...props} propKey="Gender" sm={1}/>
                    <InfoField {...props} propKey="Height" sm={1}/>
                    <InfoField {...props} propKey="Weight" sm={1}/>
                    <InfoField {...props} propKey="Hair" sm={2}/>
                    <InfoField {...props} propKey="Eyes" sm={1}/>
                    <InfoField {...props} propKey="Skin" sm={1}/>
                    <InfoField {...props} propKey="Age" sm={1}/>
                    <InfoField {...props} propKey="Alignment" sm={2}/>
                    <InfoField {...props} propKey="Deity" sm={3}/>
                    <InfoField {...props} propKey="Homeland and occupation" sm={7}/>
                    <InfoField {...props} propKey="Languages" sm={12}/>
                    </Row>
                );
            }

            function StatRow(props) {
                const ability=props.ability;
                //console.log('row base for '+ability+':', props.getState(['stat',ability,'base']);
                const abilityFields = STAT_TYPES.map( (type) =>
                    <td><TextField {...props} propKey={['stat',ability,type]} /></td>
                );
                return (
                <tr>
                    <th className="active">{ability}</th>
                    <td>{props.getAbilityTotal(ability)}</td>
                    <th className="success">{props.getAbilityMod(ability)}</th>
                    {abilityFields}
                </tr>
                );
            }


            const AbilityTable = compose(
                onlyUpdateForKeys(['stat']),
                pure
            )( props => {
                return (
                <Table condensed>
                    <thead>
                        <tr>
                            <th><small>Ability</small></th>
                            <th><small>Total</small></th>
                            <th><small>Mod</small></th>
                            <th className="ability-base"><small>Base</small></th>
                            <th><small>Enh<span className="hidden-xs hidden-md">ance</span></small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <StatRow {...props} ability="STR" />
                        <StatRow {...props} ability="DEX" />
                        <StatRow {...props} ability="CON" />
                        <StatRow {...props} ability="INT" />
                        <StatRow {...props} ability="WIS" />
                        <StatRow {...props} ability="CHA" />
                    </tbody>
                </Table>
                );
            });

            function TextField(props) {
                //console.debug(props.propKey, props.getState(props.propKey));
                return (
                <FormControl type="text"
                    id={props.propKey.join('-')}
                    value={props.getState(props.propKey)}
                    onChange={props.handleChange(props.propKey)}
                />
                );
            }
            function NoteArea(props) {
                const noteKey = props.noteKey;
                return (
                    <FormGroup controlId={noteKey+"-note"}>
                        <FormControl componentClass="textarea"
                        inputRef={autoresize} className="autoresize"
                        value={props.getState(['note',noteKey])}
                        onChange={props.handleChange(['note',noteKey])}
                        placeholder={noteKey+" notes"} />
                    </FormGroup>
                );
            }
            function NoPrintAbbr(props) {
                return (
                    <span>
                        <abbr className="hidden-print" title={props.title}>{props.children}</abbr>
                        <span className="visible-print-block">{props.children}</span>
                    </span>
                );
            }
            function ClassRow(props) {
                const rowName = props.name;
                const classFields = CLASS_TYPES.map( (type) =>
                    <td><TextField {...props} propKey={[rowName,type]} /></td>
                );
                return (
                <tr>
                    {classFields}
                </tr>
                );
            }
            function HPTable(props) {
                const totalHP = props.getAbilityMod('CON')*props.getClassTypeTotal('levels')
                                +props.getClassTypeTotal('hp');
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th className="active"><small>HP (con*lvl+cls)</small></th>
                            <td>{totalHP}</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active hp-temporary">Temporary HP</th>
                            <td><TextField {...props} propKey={['hp','temp']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Subdual dam</th>
                            <td><TextField {...props} propKey={['hp','subdual']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Lethal dam</th>
                            <td><TextField {...props} propKey={['hp','lethal']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Current HP</th>
                            <td className="success">{
                                totalHP
                                + props.getState(['hp','temp'], 0)
                                - props.getState(['hp','subdual'], 0)
                                - props.getState(['hp','lethal'], 0)
                                }</td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }
            function InitTable(props) {
                const initTotal = props.getAbilityMod('DEX')
                    + props.getState(['info','init','enh'],0)
                    + props.getState(['info','init','misc'],0)
                    + props.getState(['info','init','temp'],0);
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th></th>
                            <th><small>Total</small></th>
                            <th><small>Base</small></th>
                            <th><small>Enhance</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active">Init</th>
                            <th className="success">{initTotal}</th>
                            <td>{props.getAbilityMod('DEX')}</td>
                            <td><TextField {...props} propKey={['info','init','enh']} /></td>
                            <td><TextField {...props} propKey={['info','init','misc']} /></td>
                            <td><TextField {...props} propKey={['info','init','temp']} /></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }
            function ResistanceTable(props) {
                const initTotal = props.getAbilityMod('DEX')
                    + props.getState(['info','init','misc'],0)
                    + props.getState(['info','init','temp'],0);
                return (
                    <Table condensed>
                    <tbody>
                        <tr>
                            <th className="active">DR</th>
                            <td><TextField {...props} propKey={['info','dr']} /></td>
                            <th className="active">SR</th>
                            <td><TextField {...props} propKey={['info','sr']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Resists</th>
                            <td colSpan="3"><TextField {...props} propKey={['info','resists']} /></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }
            function SpeedTable(props) {
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th></th>
                            <th><small>Land</small></th>
                            <th><small>w/&nbsp;armor</small></th>
                            <th><small>Swim</small></th>
                            <th><small>Climb</small></th>
                            <th><small>Fly</small></th>
                            <th><small>Fly&nbsp;manu.</small></th>
                            <th><small>Burrow</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active">Speed</th>
                            <td><TextField {...props} propKey={['info','speed','land']} /></td>
                            <td><TextField {...props} propKey={['info','speed','armored']} /></td>
                            <td><TextField {...props} propKey={['info','speed','swim']} /></td>
                            <td><TextField {...props} propKey={['info','speed','climb']} /></td>
                            <td><TextField {...props} propKey={['info','speed','fly']} /></td>
                            <td><TextField {...props} propKey={['info','speed','fly','manu']} /></td>
                            <td><TextField {...props} propKey={['info','speed','burrow']} /></td>
                            <td><TextField {...props} propKey={['info','speed','misc']} /></td>
                            <td><TextField {...props} propKey={['info','speed','temp']} /></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }
            const ACTable = compose(
                onlyUpdateForKeys(['stat','armor','shield','ac']),
                pure
            )(props => {
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th><small>Defence</small></th>
                            <th><small>Total</small></th>
                            <th className="hidden-xs"></th>
                            <th><small>Armor</small></th>
                            <th><small>Shield</small></th>
                            <th><small>Dex</small></th>
                            <th><small>Size</small></th>
                            <th><small>Dodge</small></th>
                            <th><small>Natural</small></th>
                            <th><small>Deflect</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active">AC</th>
                            <th className="success">
                                {10
                                +props.getState(['armor','ac'],0)
                                +props.getState(['shield','ac'],0)
                                +props.getArmorLimitedDex()
                                +props.getState(['stat','size'],0)
                                +props.getState(['ac','dodge'],0)
                                +props.getState(['ac','natural'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','ac-misc'],0)
                                +props.getState(['ac','temp'],0)}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>{props.getState(['armor','ac'],'')}</td>
                            <td>{props.getState(['shield','ac'],'')}</td>
                            <td>{props.getArmorLimitedDex()}</td>
                            <td>{props.getState(['stat','size'],'')}</td>
                            <td><TextField {...props} propKey={['ac','dodge']} /></td>
                            <td><TextField {...props} propKey={['ac','natural']} /></td>
                            <td><TextField {...props} propKey={['ac','deflect']} /></td>
                            <td><TextField {...props} propKey={['ac','ac-misc']} /></td>
                            <td><TextField {...props} propKey={['ac','temp']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Touch</th>
                            <th className="success">
                                {10+props.getArmorLimitedDex()
                                +props.getState(['stat','size'],0)
                                +props.getState(['ac','dodge'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','touch-misc'],0)
                                +props.getState(['ac','temp'],0)}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>-</td>
                            <td>-</td>
                            <td>{props.getArmorLimitedDex()}</td>
                            <td>{props.getState(['stat','size'],'')}</td>
                            <td>{props.getState(['ac','dodge'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['ac','deflect'],'')}</td>
                            <td><TextField {...props} propKey={['ac','touch-misc']} /></td>
                            <td>{props.getState(['ac','temp'],'')}</td>
                        </tr>
                        <tr>
                            <th className="active">Flat-foot</th>
                            <th className="success">
                                {10
                                +props.getState(['armor','ac'],0)
                                +props.getState(['shield','ac'],0)
                                +props.getState(['stat','size'],0)
                                +props.getState(['ac','natural'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','ff-misc'],0)
                                +props.getState(['ac','temp'],0)}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>{props.getState(['armor','ac'],'')}</td>
                            <td>{props.getState(['shield','ac'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['stat','size'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['ac','natural'],'')}</td>
                            <td>{props.getState(['ac','deflect'],'')}</td>
                            <td><TextField {...props} propKey={['ac','ff-misc']} /></td>
                            <td>{props.getState(['ac','temp'],'')}</td>
                        </tr>
                    </tbody>
                    </Table>
                );
            });

            function SaveTableRow(props) {
                return (
                    <tr>
                        <th className="active">{props.save.toUpperCase()}</th>
                        <th className="success">{
                            props.getClassTypeTotal(props.save)
                            +props.getAbilityMod(props.ability)
                            +props.getState([props.save,'enhance'],0)
                            +props.getState([props.save,'misc'],0)
                            +props.getState([props.save,'temp'],0) }</th>
                        <td>{props.getClassTypeTotal(props.save)}</td>
                        <td>{props.getAbilityMod(props.ability)}</td>
                        <td><TextField {...props} propKey={[props.save,'enhance']}/></td>
                        <td><TextField {...props} propKey={[props.save,'misc']}/></td>
                        <td><TextField {...props} propKey={[props.save,'temp']}/></td>
                    </tr>
                );
            }
            function SaveTable(props) {
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th className="save-name">
                                <small>Save</small>
                            </th>
                            <th><small>Total</small></th>
                            <th><small><span className="hidden-xs">Class </span>base</small></th>
                            <th><small>Abil<span className="hidden-xs">ity</span></small></th>
                            <th><small>Enh<span className="hidden-xs">ance</span></small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <SaveTableRow {...props} save="fort" ability="CON"/>
                        <SaveTableRow {...props} save="ref" ability="DEX"/>
                        <SaveTableRow {...props} save="will" ability="WIS"/>
                    </tbody>
                    </Table>
                );
            }
            function AttackTable(props) {
                const strMod = props.getAbilityMod('STR');
                const dexMod = props.getAbilityMod('DEX');
                const sizeMod = props.getState(['stat','size'],0);
                const cmbAbilityMod = sizeMod < 2 ? strMod : dexMod;
                const attackRows = [
                        {name: 'melee', ability: strMod, size: sizeMod}
                        ,{name: 'ranged', ability: dexMod, size: sizeMod}
                    ].map( attack =>
                        <tr>
                            <th className="active">{attack['name'].toUpperCase()}</th>
                            <th className="success">
                                { props.getClassTypeTotal('bab')
                                + attack['ability']
                                + attack['size']
                                + props.getState([attack['name'],'misc'],0)
                                + props.getState([attack['name'],'temp'],0)
                            }</th>
                            <td className="hidden-xs"></td>
                            <td>{props.getClassTypeTotal('bab')}</td>
                            <td>{attack['ability']}</td>
                            <td>{attack['size']}</td>
                            <td><TextField {...props} propKey={[attack['name'],'misc']}/></td>
                            <td><TextField {...props} propKey={[attack['name'],'temp']}/></td>
                        </tr>
                    );
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th className="attack-name">
                                <small>Attack</small>
                            </th>
                            <th><small>Total</small></th>
                            <th className="hidden-xs"></th>
                            <th><small>BAB</small></th>
                            <th><small>Abil<span className="hidden-xs">ity</span></small></th>
                            <th><small>Size</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        {attackRows}
                        <tr>
                            <th className="active">CMB</th>
                            <th className="success">
                                {
                                props.getClassTypeTotal('bab')
                                + cmbAbilityMod
                                - sizeMod
                                + props.getState(['cmb','misc'],0)
                                + props.getState(['cmb','temp'],0)
                            }</th>
                            <td className="hidden-xs"></td>
                            <td>{props.getClassTypeTotal('bab')}</td>
                            <td><NoPrintAbbr title="STR for small and larger, DEX for tiny and smaller. Use the misc modifier to adjust for the Agile Maneuvers feat.">{cmbAbilityMod}</NoPrintAbbr></td>
                            <td><NoPrintAbbr title="*special* size modifier">{-sizeMod}</NoPrintAbbr></td>
                            <td><TextField {...props} propKey={['cmd','misc']}/></td>
                            <td><TextField {...props} propKey={['cmd','temp']}/></td>
                        </tr>
                        <tr>
                            <th className="active">CMD</th>
                            <th className="success">
                                { 10
                                + props.getClassTypeTotal('bab')
                                + strMod + dexMod
                                + props.getState(['ac','dodge'],0)
                                + props.getState(['ac','deflect'],0)
                                - sizeMod
                                + props.getState(['cmd','misc'],0)
                                + props.getState(['cmd','temp'],0)
                            }</th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>{props.getClassTypeTotal('bab')}</td>
                            <td><NoPrintAbbr title="STR+DEX+dodge+deflect">
                                    {
                                    strMod + dexMod
                                    + props.getState(['ac','dodge'],0)
                                    + props.getState(['ac','deflect'],0)
                                    }</NoPrintAbbr></td>
                            <td><NoPrintAbbr title="*special* size modifier">{-sizeMod}</NoPrintAbbr></td>
                            <td><NoPrintAbbr title="Add here any insight, luck, morale, profane, and sacred bonuses to AC"><TextField {...props} propKey={['cmd','misc']}/></NoPrintAbbr></td>
                            <td><TextField {...props} propKey={['cmd','temp']}/></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }
            function ArmorTable(props) {
                const armorKeys = ['desc','ac','max-dex','skill-penalty',
                    'spell-fail','type','weight'];
                const armorControls = armorKeys.map( (key) =>
                    <td><TextField {...props} propKey={['armor',key]} /></td>
                );
                const shieldControls = armorKeys.map( (key) =>
                    <td><TextField {...props} propKey={['shield',key]} /></td>
                );
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th></th>
                            <th className="armor-name">
                                <small>Armor name & description</small>
                            </th>
                            <th><small>AC Bonus</small></th>
                            <th><small>Max Dex</small></th>
                            <th><small>Check penalty</small></th>
                            <th><small>Spell fail</small></th>
                            <th><small>Type</small></th>
                            <th><small>Weight</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active"><small>Armor</small></th>
                            {armorControls}
                        </tr>
                        <tr>
                            <th className="active"><small>Shield</small></th>
                            {shieldControls}
                        </tr>
                    </tbody>
                    </Table>
                );
            }
            function WeaponTable(props) {
                const weaponKeys = ['desc','bonus','dmg','crit',
                    'range','type','weight','note'];
                let weaponRows = [];
                for( var i = 0; i<20; i++) {
                    if ( i>0 && isEmpty( props.getState(['weapon'+(i-1)])) ) break;
                    const cells = weaponKeys.map( (key) =>
                        <td><TextField {...props} propKey={['weapon'+i,key]} /></td>
                    );
                    const row = <tr>{cells}</tr>;
                    weaponRows = [...weaponRows,row];
                }
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th className="weapon-name">
                                <small>Weapon name & description</small>
                            </th>
                            <th className="weapon-bonus"><small>Attack bonus</small></th>
                            <th className="weapon-damage"><small>Damage</small></th>
                            <th className="weapon-critical"><small>Critical</small></th>
                            <th className="weapon-range"><small>Range</small></th>
                            <th className="weapon-type"><small>Type</small></th>
                            <th className="weapon-weight"><small>Weight</small></th>
                            <th><small>Notes & ammo</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        {weaponRows}
                    </tbody>
                    </Table>
                );
            }
            function CheckboxField(props) {
                const {propKey} = props;
                return (
                    <FormGroup controlId={propKey.join('-')}>
                        <Checkbox inline
                            checked={props.getState(propKey)}
                            onChange={props.handleChange(propKey)}>
                            {props.children}
                        </Checkbox>
                    </FormGroup>
                );
            }
            function SelectField(props) {
                const {propKey, options} = props;
                const currVal = props.getState(propKey);
                const emptyOption = options.indexOf(currVal) > -1 ? "" : <option />
                const optionList = options.map( (option,index) =>
                    <option value={option}>{option}</option> );
                return (
                    <FormGroup controlId={propKey.join('-')}>
                        <FormControl componentClass="select"
                            placeholder={props.getState(propKey)}
                            value={props.getState(propKey)}
                            onChange={props.handleChange(propKey)}>
                        {emptyOption}
                        {optionList}
                        </FormControl>
                    </FormGroup>
                );
            }

            const SKILL_AC_PENALTY_ABILITIES = ['STR','DEX'];
            function CustomSkillRow(props) {
                const {propKey} = props;
                const abilityKey = [...propKey,'ability'];
                const ability = props.getState(abilityKey);
                const hasAcPenalty = SKILL_AC_PENALTY_ABILITIES.indexOf(ability) > -1;
                const nameField = <span>
                    <TextField {...props} propKey={[...propKey,'categ']} />
                    {hasAcPenalty ? "*" : ""}
                    </span>;
                const abilityField = <SelectField {...props} propKey={abilityKey} options={STATS} />;
                return (<SkillRowBase {...props} nameField={nameField} ability={ability}
                    abilityField={abilityField} hasAcPenalty={hasAcPenalty} />);
            }
            function SkillRow(props) {
                const {propKey,name,ability,hasCategory} = props;
                const hasAcPenalty = SKILL_AC_PENALTY_ABILITIES.indexOf(ability) > -1;
                const dispName = name + (hasAcPenalty ? '*': '') + (hasCategory ? ': ': '');
                const categoryField = hasCategory
                        ? <TextField {...props} propKey={[...propKey,'categ']}/>
                        : "";
                const nameField = <span>{dispName}{categoryField}</span>;
                return (<SkillRowBase {...props} nameField={nameField} ability={ability}
                    abilityField={ability} hasAcPenalty={hasAcPenalty} />);
            }

            function SkillRowBase(props) {
                const {propKey,nameField,ability,abilityField,hasAcPenalty,isUntrainedUse} = props;
                const ranks = props.getState([...propKey,'ranks']);
                const isClass = props.getState([...propKey,'is-class']);
                return (<tr>
                    <td className="skill-name">
                        <CheckboxField {...props} propKey={[...propKey,'is-class']}>
                        <small>{nameField}</small></CheckboxField></td>
                    <td className="skill-ability"><small>{abilityField}</small></td>
                    <th className="success"><small>{
                        isUntrainedUse || ranks !== undefined ?
                            props.getState([...propKey,'ranks'],0)
                            + props.getAbilityMod(ability)
                            + (ranks>0 && isClass ? 3 : 0)
                            + props.getState([...propKey,'misc'],0)
                            + props.getState([...propKey,'temp'],0)
                            - (hasAcPenalty ? props.getState(['armor','skill-penalty'],0)
                                + props.getState(['shield','skill-penalty'],0) : 0 )
                        : ""
                            }</small></th>
                    <td><small><TextField {...props} propKey={[...propKey,'ranks']}/></small></td>
                    <td><small>{props.getAbilityMod(ability)}</small></td>
                    <td><small>{ranks>0 && isClass ? 3 : 0}</small></td>
                    <td><small><TextField {...props} propKey={[...propKey,'misc']}/></small></td>
                    <td><small><TextField {...props} propKey={[...propKey,'temp']}/></small></td>
                </tr>);
            }
            const SkillTable = compose(
                onlyUpdateForKeys(['skill', 'stat', ...CLASSES]),
                pure
            )(props => {
                const SKILL_ABILITIES = ['DEX', 'INT', 'CHA', 'STR', 'INT', 'CHA',
                    'DEX', 'CHA', 'DEX', 'DEX', 'CHA', 'WIS', 'CHA', 'INT', 'INT',
                    'WIS', 'CHA', 'WIS', 'DEX', 'WIS', 'DEX', 'INT', 'DEX', 'WIS',
                    'STR', 'CHA', ''];
                const SKILL_NAMES = ['Acrobatic', 'Appraise', 'Bluff', 'Climb',
                    'Craft', 'Diplomacy', 'Disable Device', 'Disguise',
                    'Escape Artist', 'Fly', 'Handle Animal', 'Heal', 'Intimidate',
                    'Kn', 'Linguistics', 'Perception', 'Perf', 'Prof', 'Ride',
                    'Sense Motive', 'Sleight of Hand', 'Spellcraft', 'Stealth',
                    'Survival', 'Swim', 'Use Magic Device' ];
                const SKILLS_UNTRAINED_USE = [
                    'Skill' ,'Acrobatics' ,'Appraise' ,'Bluff' ,'Climb' ,'Craft'
                    ,'Diplomacy' ,'Disguise' ,'Escape Artist' ,'Fly' ,'Heal'
                    ,'Intimidate' ,'Perception' ,'Perf' ,'Ride' ,'Sense Motive'
                    ,'Stealth' ,'Survival' ,'Swim' ];
                const CATEGORY_SKILLS = ['Craft','Kn','Perf','Prof'];
                const skillRows = SKILL_NAMES.reduce( (rows, name, i) => {
                    const hasCategory = CATEGORY_SKILLS.indexOf(name) > -1;
                    const isUntrainedUse = SKILLS_UNTRAINED_USE.indexOf(name) > -1;
                    if (!hasCategory) {
                        rows=rows.concat(<SkillRow {...props} name={name}
                            propKey={['skill',name.toLowerCase()]}
                            isUntrainedUse={isUntrainedUse}
                            ability={SKILL_ABILITIES[i]} hasCategory={hasCategory}/>);
                        return rows;
                    }
                    for( let categoryIndex = 0; categoryIndex < 10; categoryIndex++ ) {
                        const propKey = ['skill',name.toLowerCase()+categoryIndex];
                        const prevKey = ['skill',name.toLowerCase()+(categoryIndex-1)];
                        if( categoryIndex>0
                                && isEmpty(props.getState(prevKey,{}))
                                && isEmpty(props.getState(propKey,{})) ) {
                            continue;
                        }
                        rows=rows.concat(<SkillRow {...props} name={name} propKey={propKey}
                            isUntrainedUse={isUntrainedUse}
                            ability={SKILL_ABILITIES[i]} hasCategory={hasCategory}/>);
                    }
                    return rows;
                }, []);
                let customSkillRows = [];
                for( let categoryIndex = 0; categoryIndex < 10; categoryIndex++ ) {
                    const propKey = ['skill','custom'+categoryIndex];
                    const prevKey = ['skill','custom'+(categoryIndex-1)];
                    if( categoryIndex>0
                            && isEmpty(props.getState(prevKey,{}))
                            && isEmpty(props.getState(propKey,{})) ) {
                        continue;
                    }
                    customSkillRows=customSkillRows.concat(
                        <CustomSkillRow {...props} propKey={propKey} />);
                }
                const totalSkillRanks = props.getClassTypeTotal('skill');
                const assignedSkillRanks = props.skill &&
                    Object.keys(props.skill).reduce( (sum, skill) =>
                        ( sum+parseFloat('0'+props.getState(['skill',skill,'ranks']))), 0);
                const unassignedSkillRanks = totalSkillRanks - assignedSkillRanks;
                const unassignedLabel = unassignedSkillRanks ?
                    " (unused ranks "+unassignedSkillRanks+")" : "";
                return (
                    <Table striped condensed className="skill-table">
                    <thead>
                        <tr>
                            <th className="skill-name" colSpan={2}>
                                <small>Skill{unassignedLabel}</small>
                            </th>
                            <th><small>Total</small></th>
                            <th><small>Ranks</small></th>
                            <th><small>Abil</small></th>
                            <th><small>Trai</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        {skillRows}
                        {customSkillRows}
                    </tbody>
                    </Table>
                );
            });
        </script>
        <script type="text/javascript">
            function isEmpty(object) {
                return object == null ||
                    typeof(object) === 'object' && Object.keys(object).length == 0;
            }
            function autoresize(inputRef) {
                autoresize_update({target: inputRef});
                inputRef.addEventListener('input', autoresize_update, false);
            }
            function autoresize_update(e) {
                var inputRef = e.target;
                //console.log('autoresize_update',inputRef);
                inputRef.style.height = 'auto';
                inputRef.style.height = inputRef.scrollHeight+'px';
                inputRef.scrollTop = inputRef.scrollHeight;
                window.scrollTo(window.scrollLeft,(inputRef.scrollTop+inputRef.scrollHeight));
            }
        </script>
    </head>
    <body>
        <div id="root">Failed to load? :(</div>
        <script type="text/babel">
            ReactDOM.render( <App />, document.getElementById('root'));
        </script>
    </body>
</html>
