<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=0.75">
        <title>Pathfinder web character sheet</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.30.8/react-bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.24.0/babel.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/6.0.0/normalize.min.css">
        <style>
            .form-group { margin-bottom: 0px; }
            .form-control { padding: 6px 6px; }
            .class-name { width: 20%; }
            .armor-name { width: 40%; }
            .table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
                vertical-align: inherit;
            }
            @media print {
                body { zoom: 50%; }
                .col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12 {
                    float: left!important;
                }
                .col-sm-12 { width: 100%; }
                .col-sm-11 { width: 91.66666666666666%; }
                .col-sm-10 { width: 83.33333333333334%; }
                .col-sm-9 { width: 75%; }
                .col-sm-8 { width: 66.66666666666666%; }
                .col-sm-7 { width: 58.333333333333336%; }
                .col-sm-6 { width: 50%; }
                .col-sm-5 { width: 41.66666666666667%; }
                .col-sm-4 { width: 33.33333333333333%; }
                .col-sm-3 { width: 25%; }
                .col-sm-2 { width: 16.666666666666664%; }
                .col-sm-1 { width: 8.333333333333332%; }
                .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
                    float: left!important;
                }
                .col-md-12 { width: 100%; }
                .col-md-11 { width: 91.66666666666666%; }
                .col-md-10 { width: 83.33333333333334%; }
                .col-md-9 { width: 75%; }
                .col-md-8 { width: 66.66666666666666%; }
                .col-md-7 { width: 58.333333333333336%; }
                .col-md-6 { width: 50%; }
                .col-md-5 { width: 41.66666666666667%; }
                .col-md-4 { width: 33.33333333333333%; }
                .col-md-3 { width: 25%; }
                .col-md-2 { width: 16.666666666666664%; }
                .col-md-1 { width: 8.333333333333332%; }
            }
        </style>

        <script type="text/babel">
            const { Grid, Row, Col, Table, Form, Checkbox, FormGroup, FormControl, ControlLabel } = ReactBootstrap
            const STATS = ['STR','DEX','CON', 'INT','WIS','CHA'];
            const STAT_TYPES = ['base','enhance','misc','temp'];
            const CLASSES = ['class1','class2','class3','class4','class5'];
            const CLASS_TYPES = [ 'class', 'hd', 'hp', 'bab', 'skill', 'fort', 'ref', 'will', 'levels' ];

            class App extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {};
                    STATS.map( (stat) => {
                        this.state[stat] = { 'base': 10 };
                    });
                    this.state.handleChange = this.handleChange.bind(this);
                    this.state.getState = this.getState.bind(this);
                    this.state.getClassTypeTotal = this.getClassTypeTotal.bind(this);
                    this.state.getAbilityTotal = this.getAbilityTotal.bind(this);
                    this.state.getAbilityMod = this.getAbilityMod.bind(this);
                    this.state.getArmorLimitedDex = this.getArmorLimitedDex.bind(this);
                }
                componentDidUpdate(prevProps, prevState) {
                    history.pushState('','','?state='+JSON.stringify(this.state));
                }
                componentWillMount() {
                    function getQueryParams(qs) {
                        qs = qs.split('+').join(' ');
                        var params = {}, tokens, re = /[?&]?([^=]+)=([^&]*)/g;
                        while (tokens = re.exec(qs)) {
                            params[decodeURIComponent(tokens[1])] =
                                decodeURIComponent(tokens[2]);
                        }
                        return params;
                    }
                    let stateParam = getQueryParams(window.location.search).state;
                    if ( !stateParam ) return;
                    let s = JSON.parse( stateParam );
                    console.info( 'componentWillMount: restoring state:', s );
                    this.setState( s );
                }
                handleChange(propKey) {
                    //console.log('creating handleChange for '+propKey+':', propKey);
                    return (e) => {
                        const evval = e.target.value;
                        const newVal = !isNaN(parseFloat(evval)) ? parseFloat(evval) :
                            (evval && evval.length>0 && evval)
                            || undefined;
                        this.setState( (prevState, setProps) => {
                            console.log('setState', prevState, setProps, newVal);
                            let leaf = propKey.slice(0,-1).reduce(
                                ( childState, key ) => {
                                    if( childState[key] === undefined ) {
                                        return childState[key] = {};
                                    }
                                    return childState[key];
                            }, prevState );
                            leaf[propKey[propKey.length-1]] = newVal;
                            return prevState;
                        } );
                    };
                }
                getState(propKey, defaultTo) {
                    let value = this.state;
                    propKey.map((key) => { value!==undefined ? value=value[key] : 0 });
                    if( value === undefined ) return defaultTo;
                    return value;
                }
                getClassTypeTotal(type) {
                    return CLASSES.reduce( (sum, classN) =>
                        ( sum+parseFloat('0'+this.getState([classN,type]))), 0)
                }
                getAbilityTotal(ability) {
                    return STAT_TYPES.reduce(
                        (sum,type) =>
                            sum + parseInt(this.getState([ability,type])||0), 0);
                }
                getAbilityMod(ability) {
                    return Math.round((this.getAbilityTotal(ability)-11)/2);
                }
                getArmorLimitedDex() {
                    return Math.min(
                        this.getAbilityMod('DEX'),
                        this.getState(['armor','max-dex'], Infinity),
                        this.getState(['shield','max-dex'], Infinity));
                }
                render() {
                    return (
                    <Grid fluid>
                    <Form>
                        <Row>
                        <Field {...this.state} propKey="Character" xs={8} sm={6}/>
                        <Field {...this.state} propKey="Player" xs={4} sm={6}/>
                        <Field {...this.state} propKey="Race" sm={3}/>
                        <Field {...this.state} propKey="Size" sm={1}/>
                        <Field {...this.state} propKey="Gender" sm={1}/>
                        <Field {...this.state} propKey="Height" sm={1}/>
                        <Field {...this.state} propKey="Weight" sm={1}/>
                        <Field {...this.state} propKey="Hair" sm={2}/>
                        <Field {...this.state} propKey="Eyes" sm={1}/>
                        <Field {...this.state} propKey="Skin" sm={1}/>
                        <Field {...this.state} propKey="Age" sm={1}/>
                        <Field {...this.state} propKey="Alignment" sm={2}/>
                        <Field {...this.state} propKey="Deity" sm={3}/>
                        <Field {...this.state} propKey="Homeland and occupation" sm={7}/>
                        <Field {...this.state} propKey="Languages" sm={12}/>
                        </Row>
                        <Row>
                        <Col md={5}>
                        <Table condensed>
                            <thead>
                                <tr>
                                    <th><small>ability</small></th>
                                    <th><small>total</small></th>
                                    <th><small>mod</small></th>
                                    <th><small>base</small></th>
                                    <th><small>enhance</small></th>
                                    <th><small>misc</small></th>
                                    <th><small>temp</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                <StatRow {...this.state} ability="STR" />
                                <StatRow {...this.state} ability="DEX" />
                                <StatRow {...this.state} ability="CON" />
                                <StatRow {...this.state} ability="INT" />
                                <StatRow {...this.state} ability="WIS" />
                                <StatRow {...this.state} ability="CHA" />
                            </tbody>
                        </Table>
                        </Col>
                        <Col md={7}>
                        <Table condensed>
                            <thead>
                                <tr>
                                    <th className="class-name"><small>classname</small></th>
                                    <th><small>HD</small></th>
                                    <th><small>HP</small></th>
                                    <th><small>BAB</small></th>
                                    <th><small>skill</small></th>
                                    <th><small>fort</small></th>
                                    <th><small>ref</small></th>
                                    <th><small>will</small></th>
                                    <th><small>levels</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                <ClassRow {...this.state} name="class1" />
                                <ClassRow {...this.state} name="class2" />
                                <ClassRow {...this.state} name="class3" />
                                <ClassRow {...this.state} name="class4" />
                                <ClassRow {...this.state} name="class5" />
                                <tr>
                                    <th>totals</th>
                                    <th></th>
                                    <th className="success">{this.getClassTypeTotal('hp')}</th>
                                    <th>{this.getClassTypeTotal('bab')}</th>
                                    <th>{this.getClassTypeTotal('skill')}</th>
                                    <th>{this.getClassTypeTotal('fort')}</th>
                                    <th>{this.getClassTypeTotal('ref')}</th>
                                    <th>{this.getClassTypeTotal('will')}</th>
                                    <th>{this.getClassTypeTotal('levels')}</th>
                                </tr>
                            </tbody>
                        </Table>
                        </Col>
                        </Row>
                        <Row>
                        <Col md={7}>
                        <ACTable {...this.state}/>
                        <Row>
                            <Col md={8}>
                                <SaveTable {...this.state}/>
                            </Col>
                        </Row>
                        <ArmorTable {...this.state}/>
                        </Col>
                        </Row>
                    </Form>
                    </Grid>
                    );
                }
            }
        </script>

        <script type="text/babel">
            function Field(props) {
                const statePropKey = ['info', props.propKey];
                return (
                <Col bsClass="col" xs={props.xs || Math.min(props.sm*2, 12)} sm={props.sm}>
                <FormGroup controlId={statePropKey.join('-')} bsSize="sm">
                <ControlLabel>
                <small>{props.propKey}</small>
                </ControlLabel>
                <FormControl type="text"
                    value={props.getState(statePropKey)}
                    onChange={props.handleChange(statePropKey)}
                />
                </FormGroup>
                </Col>
                );
            }

            function StatRow(props) {
                const ability=props.ability;
                //console.log('row base for '+ability+':', props[ability]['base']);
                const valueRows = STAT_TYPES.map( (type) =>
                    <td><StatePropControl {...props}
                        propKey={[ability,type]} />
                    </td> );
                return (
                <tr>
                    <th className="active">{ability}</th>
                    <td className="text-center">{props.getAbilityTotal(ability)}</td>
                    <th className="success text-center">{props.getAbilityMod(ability)}</th>
                    {valueRows}
                </tr>
                );
            }
            function StatePropControl(props) {
                //console.debug(props.propKey, props.getState(props.propKey));
                return (
                <FormControl type="text"
                    name={props.propKey.join('-')}
                    value={props.getState(props.propKey)}
                    onChange={props.handleChange(props.propKey)}
                />
                );
            }
            function ClassRow(props) {
                const rowName = props.name;
                const valueRows = CLASS_TYPES.map( (type) =>
                    <td><StatePropControl {...props}
                        propKey={[rowName,type]} />
                    </td> );
                return (
                <tr>
                    {valueRows}
                </tr>
                );
            }
            function ACTable(props) {
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th></th>
                            <th><small>Total</small></th>
                            <th className="hidden-xs"></th>
                            <th><small>Armor</small></th>
                            <th><small>Shield</small></th>
                            <th><small>Dex</small></th>
                            <th><small>Size</small></th>
                            <th><small>Dodge</small></th>
                            <th><small>Natural</small></th>
                            <th><small>Deflect</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active">AC</th>
                            <th className="success text-center">
                                {10
                                +props.getState(['armor','ac'],0)
                                +props.getState(['shield','ac'],0)
                                +props.getArmorLimitedDex()
                                +props.getState(['ac','size'],0)
                                +props.getState(['ac','dodge'],0)
                                +props.getState(['ac','natural'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','ac-misc'],0)
                                +props.getState(['ac','temp'],0)}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>{props.getState(['armor','ac'],'')}</td>
                            <td>{props.getState(['shield','ac'],'')}</td>
                            <td>{props.getArmorLimitedDex()}</td>
                            <td><StatePropControl {...props}
                                propKey={['ac','size']} />
                            </td>
                            <td><StatePropControl {...props}
                                propKey={['ac','dodge']} />
                            </td>
                            <td><StatePropControl {...props}
                                propKey={['ac','natural']} />
                            </td>
                            <td><StatePropControl {...props}
                                propKey={['ac','deflect']} />
                            </td>
                            <td><StatePropControl {...props}
                                propKey={['ac','ac-misc']} />
                            </td>
                            <td><StatePropControl {...props}
                                propKey={['ac','temp']} />
                            </td>
                        </tr>
                        <tr>
                            <th className="active">Touch</th>
                            <th className="success text-center">
                                {10+props.getArmorLimitedDex()
                                +props.getState(['ac','size'],0)
                                +props.getState(['ac','dodge'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','touch-misc'],0)
                                +props.getState(['ac','temp'],0)}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>-</td>
                            <td>-</td>
                            <td>{props.getArmorLimitedDex()}</td>
                            <td>{props.getState(['ac','size'],'')}</td>
                            <td>{props.getState(['ac','dodge'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['ac','deflect'],'')}</td>
                            <td><StatePropControl {...props}
                                propKey={['ac','touch-misc']} />
                            </td>
                            <td>{props.getState(['ac','temp'],'')}</td>
                        </tr>
                        <tr>
                            <th className="active">Flat-foot</th>
                            <th className="success text-center">
                                {10
                                +props.getState(['armor','ac'],0)
                                +props.getState(['shield','ac'],0)
                                +props.getState(['ac','size'],0)
                                +props.getState(['ac','natural'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','ff-misc'],0)
                                +props.getState(['ac','temp'],0)}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>{props.getState(['armor','ac'],'')}</td>
                            <td>{props.getState(['shield','ac'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['ac','size'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['ac','natural'],'')}</td>
                            <td>{props.getState(['ac','deflect'],'')}</td>
                            <td><StatePropControl {...props}
                                propKey={['ac','ff-misc']} />
                            </td>
                            <td>{props.getState(['ac','temp'],'')}</td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }
            function SaveTable(props) {
                function SaveRow(props) {
                    return (
                        <tr>
                            <th className="active">{props.save.toUpperCase()}</th>
                            <th className="success"><small>{
                                props.getClassTypeTotal(props.save)
                                +props.getAbilityMod(props.ability)
                                +props.getState([props.save,'enhance'],0)
                                +props.getState([props.save,'misc'],0)
                                +props.getState([props.save,'temp'],0) }</small></th>
                            <td>{props.getClassTypeTotal(props.save)}</td>
                            <td>{props.getAbilityMod(props.ability)}</td>
                            <td><StatePropControl {...props} propKey={[props.save,'enhance']}/></td>
                            <td><StatePropControl {...props} propKey={[props.save,'misc']}/></td>
                            <td><StatePropControl {...props} propKey={[props.save,'temp']}/></td>
                        </tr>
                    );
                }
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th className="save-name">
                                <small>Saving throw</small>
                            </th>
                            <th><small>Total</small></th>
                            <th><small>Class base</small></th>
                            <th><small>Ability</small></th>
                            <th><small>Enhance</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <SaveRow {...props} save="fort" ability="CON"/>
                        <SaveRow {...props} save="ref" ability="DEX"/>
                        <SaveRow {...props} save="will" ability="WIS"/>
                    </tbody>
                    </Table>
                );
            }
            function ArmorTable(props) {
                const armorKeys = ['desc','ac','max-dex','skill-penalty',
                    'spell-fail','type','weight'];
                const armorControls = armorKeys.map( (key) =>
                    <td><StatePropControl {...props}
                        propKey={['armor',key]} />
                    </td>
                );
                const shieldControls = armorKeys.map( (key) =>
                    <td><StatePropControl {...props}
                        propKey={['shield',key]} />
                    </td>
                );
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th></th>
                            <th className="armor-name">
                                <small>Armor name & description</small>
                            </th>
                            <th><small>AC Bonus</small></th>
                            <th><small>Max Dex</small></th>
                            <th><small>Check penalty</small></th>
                            <th><small>Spell fail</small></th>
                            <th><small>Type</small></th>
                            <th><small>Weight</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active"><small>Armor</small></th>
                            {armorControls}
                        </tr>
                        <tr>
                            <th className="active"><small>Shield</small></th>
                            {shieldControls}
                        </tr>
                    </tbody>
                    </Table>
                );
            }
        </script>
    </head>
    <body>
        <div id="root"></div>
        <script type="text/babel">
            ReactDOM.render( <App />, document.getElementById('root'));
        </script>
    </body>
</html>
