<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=0.75">
        <title>Pathfinder web character sheet</title>
        <!--script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script>-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.5.4/react.min.js" integrity="sha256-lLTXVU5NHLl101VgD3LswV6ZgI2PjSjZ5dVzhBcq52k=" crossorigin="anonymous"></script>
        <!--script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.5.4/react-with-addons.min.js" integrity="sha256-ykoK6YBjgeCBJDtPZysq9Jad9t24BfFNtlmmr61nfnw=" crossorigin="anonymous"></script-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.5.4/react-dom.min.js" integrity="sha256-4DRNdBX+quo7fRIFuR9yhr157hq/9FcAsHRDNQEXZSM=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.30.10/react-bootstrap.min.js" integrity="sha256-0f2lNftVu5NhiwAcZzgUV8BVpft8Zy+dVvnMbBzkKCw=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/recompose/0.23.1/Recompose.min.js" integrity="sha256-XDhSiYRiccAHw3isP5XYFAFZXetrB0/7K1WtlhlfoyM=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.24.0/babel.min.js" integrity="sha256-GD3ItO3la9UgSsiiVIn1briRJCxizFqORPaIveATvcI=" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/6.0.0/normalize.min.css">
        <style>
            #root .form-group { margin-bottom: 0px; }
            #root .form-control { padding: 6px 6px; }
            #root .class-name { width: 20%; }
            #root .armor-name { width: 40%; }
            #root .weapon-name { width: 25%; }
            #root .weapon-bonus { width: 4%; }
            #root .weapon-damage { width: 12%; }
            #root .weapon-critical { width: 7%; }
            #root .weapon-range { width: 8%; }
            #root .weapon-type { width: 3%; }
            #root .weapon-weight { width: 3%; }
            #root .ability-table .ability-base {
                width: 15%;
            }
            #ability-note { min-height: 212px; }
            #root .skill-table .skill-name {
                width: 40%;
                text-align: left;
            }
            #root .hp-table .hp-temporary {
                min-width: 110px;
            }
            #root .note-col {
                padding-bottom: 5px;
            }
            #save-note { min-height: 171px; }
            #attack-note { min-height: 196px; }
            #root .skill-table input.form-control, #root .skill-table select.form-control {
                font-size: 100%; /*inherit small*/
                height: 22px;
            }
            #root .skill-table td.skill-ability {
                padding: 3px;
                width: 12%;
            }
            #root .skill-ability select.form-control {
                padding: 0;
                line-height: 20px;
                -moz-appearance: none;
                -webkit-appearance:none;
            }
            #root .skill-ability select::-ms-expand {
                display: none;
            }
            #root .equipment-table .equipment-name {
                width: 80%;
                text-align: left;
            }
            #spell-note { min-height: 92px; }

            #root textarea.form-control.onerow {
                height: 34px;
            }
            #root .checkbox-inline input[type=text] {
                display: inline;
                width: 70%;
            }
            #root textarea.autoresize {
                height: auto;
                display: block;
                overflow: hidden;
                resize: none;
            }
            #root .navbar {
                margin: 12px;
            }
            #root .navbar .checkbox, #root .navbar .radio {
                margin: 0;
            }
            #root .table>thead>tr>td, #root .table>thead>tr>th {
                vertical-align: bottom;
            }
            #root .table>tbody>tr>td, #root .table>tbody>tr>th, #root .table>tfoot>tr>td, #root .table>tfoot>tr>th {
                vertical-align: middle;
            }
            #root .table>thead>tr>td,
            #root .table>tbody>tr>th.success, #root .table>tbody>tr>td, #root .table>tfoot>tr>td {
                text-align: center;
            }
            @media print {
                body { zoom: 50%; }
                .col-sm-1, .col-sm-2, .col-sm-3, .col-sm-4, .col-sm-5, .col-sm-6, .col-sm-7, .col-sm-8, .col-sm-9, .col-sm-10, .col-sm-11, .col-sm-12 {
                    float: left!important;
                }
                .col-sm-12 { width: 100%; }
                .col-sm-11 { width: 91.66666666666666%; }
                .col-sm-10 { width: 83.33333333333334%; }
                .col-sm-9 { width: 75%; }
                .col-sm-8 { width: 66.66666666666666%; }
                .col-sm-7 { width: 58.333333333333336%; }
                .col-sm-6 { width: 50%; }
                .col-sm-5 { width: 41.66666666666667%; }
                .col-sm-4 { width: 33.33333333333333%; }
                .col-sm-3 { width: 25%; }
                .col-sm-2 { width: 16.666666666666664%; }
                .col-sm-1 { width: 8.333333333333332%; }
                .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
                    float: left!important;
                }
                .col-md-12 { width: 100%; }
                .col-md-11 { width: 91.66666666666666%; }
                .col-md-10 { width: 83.33333333333334%; }
                .col-md-9 { width: 75%; }
                .col-md-8 { width: 66.66666666666666%; }
                .col-md-7 { width: 58.333333333333336%; }
                .col-md-6 { width: 50%; }
                .col-md-5 { width: 41.66666666666667%; }
                .col-md-4 { width: 33.33333333333333%; }
                .col-md-3 { width: 25%; }
                .col-md-2 { width: 16.666666666666664%; }
                .col-md-1 { width: 8.333333333333332%; }
            }
        </style>

        <script type="text/babel">
            const { Glyphicon, Grid, Row, Col, Table, Form, Checkbox, FormGroup, FormControl, ControlLabel, ButtonToolbar, Button, ButtonGroup, DropdownButton, MenuItem, Navbar, Nav, NavDropdown, Panel } = ReactBootstrap;
            const { pure, compose, onlyUpdateForKeys  } = Recompose;
            const STATS = ['STR','DEX','CON', 'INT','WIS','CHA'];
            const STAT_TYPES = ['base','enhance','misc','temp'];
            const CLASSES = ['class1','class2','class3','class4','class5'];
            const CLASS_TYPES = [ 'class', 'hd', 'hp', 'bab', 'skill', 'fort', 'refl', 'will', 'levels' ];
            const WEAPONS = ['weapon0', 'weapon1','weapon2','weapon3','weapon4','weapon5',
                'weapon6','weapon7','weapon8','weapon9','weapon10',
                'weapon11','weapon12','weapon13','weapon14','weapon15',
                'weapon16','weapon17','weapon18','weapon19','weapon20'];
            const SAVES = ['fort','refl','will'];

            class App extends React.Component {
                constructor(props) {
                    super(props);
                    this.prevChangeWasToKey = '';
                    this.state = {stat:{ size:0 }, note:{}};
                    STATS.map( (stat) => {
                        this.state.stat[stat] = { 'base': 10 };
                    });
                    this.prevHistoryPushWasWithKey;
                    this.isLoading = false;
                    this.fn = {};
                    this.fn.handleChange =  this.handleChange.bind(this);
                    this.fn.getState = this.getState.bind(this);
                    this.fn.getClassTypeTotal = this.getClassTypeTotal.bind(this);
                    this.fn.getAbilityTotal = this.getAbilityTotal.bind(this);
                    this.fn.getAbilityMod = this.getAbilityMod.bind(this);
                    this.fn.getArmorLimitedDex = this.getArmorLimitedDex.bind(this);
                }

                componentDidUpdate(prevProps, prevState) {
                    const title = this.getState(['info','character'])
                        + '(lvl' + this.getClassTypeTotal('levels') + '): '
                        + (this.prevChangeWasToKey || '');
                    if( this.isLoading ) { // push no state while loading
                        document.title = title;
                        return;
                    }
                    let result = {};
                    function recurse (cur, prop) {
                        if ( cur === undefined ) {
                            console.debug('componentDidUpdate: skipping undefined at', prop);
                        } else if( typeof(cur) == 'function' ) {
                            console.warn( 'componentDidUpdate: function at', prop);
                        } else if (Object(cur) !== cur) {
                            console.debug( 'componentDidUpdate saving:', prop, cur, typeof cur);
                            result[prop] = cur;
                        } else if( Array.isArray( cur ) ) {
                            console.warn( 'componentDidUpdate: skipping array at', prop );
                        } else {
                            for (var p in cur) {
                                recurse(cur[p], prop ? prop+"."+p : p);
                            }
                        }
                    }
                    recurse(this.state, "");
                    var qp = "";
                    for (var k in result) {
                        qp += "&" + k + "=" + encodeURIComponent( result[k] );
                    }
                    if ( ''+this.prevHistoryPushWasWithKey == ''+this.prevChangeWasToKey ) {
                        console.debug('history.replaceState', title);
                        history.replaceState(this.state , title, '?' + qp.slice(1).replace( /\%20/g, '+' ));
                    } else {
                        console.debug('history.pushState', title);
                        history.pushState(this.state, title, '?' + qp.slice(1).replace( /\%20/g, '+' ));
                        this.prevHistoryPushWasWithKey = this.prevChangeWasToKey;
                    }
                    document.title = title;
                }

                componentWillMount() {
                    function convertKey(k) {
                        if( STATS.indexOf( k.split('.')[0] )>-1 ) return 'stat.'+k;
                        if( k == 'info.size' || k == 'size') return 'stat.size';
                        if( k.indexOf('info') == 0 ) k = k.toLowerCase();
                        if( k.indexOf('info.init') == 0 ) return k.replace('info.init', 'init');
                        if( k.indexOf('info.speed') == 0 ) return k.replace('info.speed', 'speed');
                        if( k.indexOf('acrobatic.') > 0 ) return k.replace('acrobatic.', 'acrobatics.');
                        if( /refl*\./.test(k) ) return k.replace(/refl*\./, 'refl.');
                        return k;
                    }
                    function getQueryParams(qs) {
                        qs = qs.split('+').join(' ');
                        var params = {}, tokens, re = /[?&]?([^=]+)=([^&]*)/g;
                        while (tokens = re.exec(qs)) {
                            let key = decodeURIComponent(tokens[1]);
                            let value = decodeURIComponent(tokens[2]);
                            if( key.indexOf('prevChangeWasToKey')==0 ) continue;
                            if( value == ({}).toString() ) continue;
                            params[ convertKey( key ) ] = value;
                        }
                        return params;
                    }
                    const queryParams = getQueryParams(window.location.search);
                    this.isLoading = true;
                    if ( queryParams.state ) {
                        // depracated old state format
                        let s = JSON.parse( queryParams.state );
                        console.info( 'componentWillMount: restoring state:', s );
                        this.setState( s, restoreReady );
                    } else {
                        this.setState( (ps, pp) => {
                            for( var k in queryParams ) {
                                this.setStateByKey( k.split('.'), queryParams[k] );
                            }
                        }, restoreReady );
                    }
                    function restoreReady() {
                        console.info( 'componentWillMount: restored state:', this.state );
                        this.prevChangeWasToKey = [""];
                        this.componentDidUpdate( null, null );
                        autoresizeAll();
                        this.isLoading = false;
                    }
                }

                popstateRestore(event) {
                    console.log( 'popstate: restoring state', event.state, 'from', event );
                    this.isLoading = true;
                    this.setState( event.state, () => {
                        console.debug('popstate: forcing update');
                        this.forceUpdate( () => {
                            this.isLoading = false;
                            console.debug('popstate: restoring state complete:', this.state );
                            autoresizeAll();
                        });
                    });
                }

                componentDidMount() {
                    window.onpopstate = event => this.popstateRestore(event);
                }

                withPropKeyValue( prevState, propKey, newVal ) {
                    newVal = (newVal == parseFloat(newVal).toString()) ? parseFloat(newVal) : newVal;
                    newVal = newVal === 'false' ? false : newVal;
                    const newState = {};
                    let newLeaf = newState;
                    let leaf = propKey.slice(0,-1).reduce(
                        ( childState, key ) => {
                            if( childState[key] === undefined ) {
                                return newLeaf = newLeaf[key] = {};
                            }
                            newLeaf = newLeaf[key] = {...childState[key]};
                            return childState[key];
                        }, prevState );
                    const oldVal = leaf[propKey[propKey.length-1]];
                    newLeaf[propKey[propKey.length-1]] = newVal;
                    //console.debug('with', propKey, newState, 'was', oldVal);
                    return newState;
                }
                setStateByKey( propKey, newVal ) {
                    this.setState( (prevState, setProps) => {
                        const newState = this.withPropKeyValue( prevState, propKey, newVal );
                        this.prevChangeWasToKey = propKey;
                        //console.log('setState', propKey, newVal, newState, 'of', prevState, setProps);
                        return newState;
                    } );
                }
                handleChange( propKey, mutator ) {
                    return (e) => {
                        if( mutator !== undefined ) {
                            const oldVal = this.getState( propKey );
                            const newVal = mutator( oldVal, e );
                            // console.debug('handleChange mutator:', propKey, newVal, oldVal, mutator);
                            return this.setStateByKey( propKey, newVal);
                        }
                        const evval = e.target.type === 'checkbox' ? e.target.checked
                            : e.target.value;
                        const newVal =
                            typeof(evval)==='boolean' ? evval || undefined :
                            evval.length==0 ? undefined :
                            evval;
                        // console.log('handleChange event', propKey, newVal, evval, e.target);
                        this.setStateByKey( propKey, newVal );
                    };
                }
                getState(propKey, defaultTo) {
                    if( typeof defaultTo === 'number' ) {
                        return Number( this.getState( propKey ) || defaultTo );
                    }
                    if( typeof defaultTo === 'boolean' ) {
                        return this.getState( propKey, 'false' ).toString() === 'true';
                    }
                    if( !Array.isArray(propKey) ) {
                        throw new Error('propKey must be an array: ' + propKey);
                    }
                    const stateVal = propKey.reduce((tree, key) =>
                        typeof tree == 'object' && key in tree ? tree[key] : undefined, this.state );
                    return stateVal !== undefined ? stateVal : defaultTo;
                }
                getClassTypeTotal(type) {
                    return CLASSES.reduce( (sum, classN) =>
                        ( sum+this.getState([classN,type],0)), 0)
                }
                getAbilityTotal(ability, skipTemp=false) {
                    if (STATS.indexOf(ability) == -1) return NaN;
                    const rageBonus = this.getState(['rage','enable']) && !skipTemp
                        ? getRageState(this.fn)[ability] || 0 : 0;
                    return STAT_TYPES.filter(x=>!skipTemp||x!=='temp').reduce(
                        (sum,type) =>
                            sum + this.getState(['stat',ability,type], 0), 0)
                        +rageBonus;
                }
                getAbilityMod(ability, skipTemp) {
                    return Math.round((this.getAbilityTotal(ability, skipTemp)-11)/2);
                }
                getArmorLimitedDex() {
                    return Math.min(
                        this.getAbilityMod('DEX'),
                        this.getState(['armor','max-dex'], Infinity),
                        this.getState(['shield','max-dex'], Infinity));
                }
                render() {
                    return (
                    <Form>
                    <Grid fluid>
                        <InfoRow {...this.fn} {...this.state} />
                        <Row>
                        <Col md={5}>
                        <Row>
                            <Col xs={8} sm={9}>
                                <AbilityTable {...this.fn} {...this.state} />
                            </Col>
                            <SizeField className="note-col" {...this.fn} {...this.state} sm={3} xs={4}/>
                            <Col xs={4} sm={3} className="note-col">
                                <NoteArea {...this.fn} noteKey="ability" val={this.state.note.ability} />
                            </Col>
                        </Row>
                        </Col>
                        <Col md={7}>
                        <ClassTable {...this.fn} {...this.state} />
                        </Col>
                        </Row>
                        <Row>
                        <Col md={7}>
                            <SpeedTable {...this.fn} {...this.state} />
                            <Row>
                            <Col xs={7}>
                                <InitTable {...this.fn} {...this.state}/>
                                <ResistanceTable {...this.fn} {...this.state}/>
                            </Col>
                            <Col xs={5}>
                                <HPTable {...this.fn} {...this.state}/>
                            </Col>
                        </Row>
                        <ACTable {...this.fn} {...this.state}/>
                        <Row>
                            <Col xs={8}>
                                <SaveTable {...this.fn} {...this.state}/>
                            </Col>
                            <Col xs={4} className="note-col">
                                <NoteArea {...this.fn} noteKey="save" val={this.state.note.save} />
                            </Col>
                        </Row>
                        <Row>
                            <Col xs={8}>
                                <AttackTable {...this.fn} {...this.state} />
                            </Col>
                            <Col xs={4} className="note-col">
                                <NoteArea {...this.fn} noteKey="attack" val={this.state.note.attack} />
                            </Col>
                        </Row>
                        <ArmorTable {...this.fn}/>
                        </Col>
                        <Col md={5}>
                            <SkillTable {...this.fn} {...this.state} />
                        </Col>
                        <Col xs={12}>
                            <WeaponTable {...this.fn} {...this.state}/>
                        </Col>
                        </Row>
                        <Row>
                            <Col sm={12} md={6} className="note-col">
                                <NoteArea {...this.fn} noteKey="feat" val={this.state.note.feat} />
                            </Col>
                            <Col sm={12} md={6} className="note-col">
                                <NoteArea {...this.fn} noteKey="character" val={this.state.note.character} />
                            </Col>
                        </Row>
                        <Row>
                            <Col sm={12} md={6} className="note-col">
                                <NoteArea {...this.fn} noteKey="special" val={this.state.note.special} />
                            </Col>
                            <Col sm={12} md={6} className="note-col">
                                <NoteArea {...this.fn} noteKey="equipment" val={this.state.note.equipment} />
                            </Col>
                        </Row>
                        <EquipmentTable {...this.fn} {...this.state} />
                        <RagePanel {...this.fn} {...this.state} />
                        <SpellTablePanel {...this.fn} {...this.state} />
                    </Grid>
                    <AddfieldsNavbar {...this.fn} {...this.state} />
                    </Form>
                    );
                }
            }
        </script>

        <script type="text/babel">
            function ColText(props) {
                return (
                <Col bsClass="col" xs={props.xs || Math.min(props.sm*2, 12)} sm={props.sm}>
                <FormGroup validationState={props.validationState} bsSize="sm">
                    <ControlLabel>
                        <small>{props.label}</small>
                    </ControlLabel>
                    <FormControl.Static>
                        {props.children}
                    </FormControl.Static>
                </FormGroup>
                </Col>
                );
            }

            function ColTextField(props) {
                const label = props.label || props.propKey[props.propKey.length-1];
                return (
                <Col bsClass="col" xs={props.xs || Math.min(props.sm*2, 12)} sm={props.sm}>
                <FormGroup validationState={props.validationState}
                    controlId={props.propKey.join('-')} bsSize="sm">
                <ControlLabel className="text-capitalize">
                <small>{label}</small>
                </ControlLabel>
                <FormControl type="text"
                    value={props.getState(props.propKey,'')}
                    onChange={props.handleChange(props.propKey)}
                />
                </FormGroup>
                </Col>
                );
            }

            function SizeField(props) {
                const sizeValues = [8,4,2,1,0,-1,-2,-4,-8];
                const sizeOptions = ['Fine','Diminutive','Tiny','Small','Medium'
                    ,'Large','Huge','Gargantuan','Colossal'].map( (sizeName,index) =>
                    <option value={sizeValues[index]}>
                        {sizeName+': '+sizeValues[index]}</option> );
                const statePropKey = ['stat', 'size'];
                return (
                <Col {...props} bsClass="col" xs={props.xs || Math.min(props.sm*2, 12)}>
                <FormGroup controlId={statePropKey.join('-')} bsSize="sm">
                <ControlLabel>
                <small>Size</small>
                </ControlLabel>
                <FormControl componentClass="select"
                    value={props.getState(statePropKey)}
                    onChange={props.handleChange(statePropKey)}>
                        {sizeOptions}
                </FormControl>
                </FormGroup>
                </Col>
                );
            }

            const InfoRow = compose(
                onlyUpdateForKeys(['info','stat']), pure)(InfoRowImpl);
            function InfoRowImpl(props) {
                return (
                    <Row>
                    <ColTextField {...props} propKey={['info','character']} xs={7} sm={6}/>
                    <ColTextField {...props} propKey={['info','player']} xs={3} sm={5}/>
                    <Col xs={2} sm={1}>
                        <div><small>Minify<span className="hidden-xs"> URL</span></small></div>
                        <Button
                            bsStyle="info" target="_blank"
                            href="javascript:window.open('http://www.dy.fi/?c=redir_add&bml=1&url='+encodeURIComponent(location.href), '_blank')">
                            dy.fi</Button>
                    </Col>
                    <ColTextField {...props} propKey={['info','race']} sm={2}/>
                    <ColTextField {...props} propKey={['info','gender']} sm={1}/>
                    <ColTextField {...props} propKey={['info','height']} sm={1}/>
                    <ColTextField {...props} propKey={['info','weight']} sm={1}/>
                    <ColTextField {...props} propKey={['info','hair']} sm={2}/>
                    <ColTextField {...props} propKey={['info','eyes']} sm={2}/>
                    <ColTextField {...props} propKey={['info','skin']} sm={2}/>
                    <ColTextField {...props} propKey={['info','age']} sm={1}/>
                    <ColTextField {...props} propKey={['info','alignment']} sm={2}/>
                    <ColTextField {...props} propKey={['info','deity']} sm={3}/>
                    <ColTextField {...props} propKey={['info','homeland and occupation']} sm={7}/>
                    <ColTextField {...props} propKey={['info','languages']} sm={12}/>
                    </Row>
                );
            }

            function StatRow(props) {
                const ability=props.ability;
                //console.log('row base for '+ability+':', props.getState(['stat',ability,'base']);
                const raging = props.getState(['rage','enable'],false);
                const rageBonus = raging ? getRageState(props)[ability] : 0;
                const abilityFields = STAT_TYPES.map( (type) =>
                    <td><TextField {...props} propKey={['stat',ability,type]} /></td>
                    ).concat( <td className={raging?"":"hidden"}>{rageBonus||""}</td>);
                return (
                <tr>
                    <th className="active">{ability}</th>
                    <td>{props.getAbilityTotal(ability)}</td>
                    <th className="success">{props.getAbilityMod(ability)}</th>
                    {abilityFields}
                </tr>
                );
            }

            const AbilityTable = compose(
                onlyUpdateForKeys(['stat','rage']), pure)(AbilityTableImpl);
            function AbilityTableImpl(props) {
                const raging = props.getState(['rage','enable'],false);
                return (
                <Table condensed className="ability-table">
                    <thead>
                        <tr>
                            <th><small>Ability</small></th>
                            <th><small>Total</small></th>
                            <th><small>Mod</small></th>
                            <th className="ability-base"><small>Base</small></th>
                            <th><small>Enh<span className="hidden-xs hidden-md">ance</span></small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                            <th className={raging?"":"hidden"}><small>Rage</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <StatRow {...props} ability="STR" />
                        <StatRow {...props} ability="DEX" />
                        <StatRow {...props} ability="CON" />
                        <StatRow {...props} ability="INT" />
                        <StatRow {...props} ability="WIS" />
                        <StatRow {...props} ability="CHA" />
                    </tbody>
                </Table>
                );
            }

            function TextField(props) {
                //console.debug(props.propKey, props.getState(props.propKey));
                return (
                <FormControl type="text"
                    id={props.propKey.join('-')}
                    value={props.getState(props.propKey, '')}
                    onChange={props.handleChange(props.propKey)}
                    placeholder={props.placeholder}
                    className={props.className||''}
                />
                );
            }

            const NoteArea = pure(NoteAreaImpl);
            function NoteAreaImpl(props) {
                const noteKey = props.noteKey || props.propKey[props.propKey.length-1];
                const propKey = props.propKey || ['note',noteKey];
                const className = [props.className
                    ,"autoresize"
                    ,propKey.join('-')
                    ,props.onerow ? "onerow" : ""].join(' ');
                return (
                    <FormGroup controlId={noteKey+"-note"}>
                        <FormControl componentClass="textarea"
                        inputRef={addAutoresize}
                        className={className}
                        value={props.getState(propKey,'')}
                        onChange={props.handleChange(propKey)}
                        placeholder={props.placeholder || noteKey+" notes"} />
                    </FormGroup>
                );
            }

            function NoPrintAbbr(props) {
                return (
                    <span>
                        <abbr className="hidden-print" title={props.title}>{props.children}</abbr>
                        <span className="visible-print-block">{props.children}</span>
                    </span>
                );
            }

            const ClassRow = pure(ClassRowImpl);
            function ClassRowImpl(props) {
                const rowName = props.name;
                const classFields = CLASS_TYPES.map( (type) =>
                    <td><TextField {...props} propKey={[rowName,type]} /></td>
                );
                return (
                <tr>
                    {classFields}
                </tr>
                );
            }

            const ClassTable = compose(
                onlyUpdateForKeys([...CLASSES]), pure)(ClassTableImpl);
            function ClassTableImpl(props) {
                return (
                    <Table condensed>
                        <thead>
                            <tr>
                                <th className="class-name"><small>Classname</small></th>
                                <th><small>HD</small></th>
                                <th><small>HP</small></th>
                                <th><small>BAB</small></th>
                                <th><small>Skill</small></th>
                                <th><small>FORT</small></th>
                                <th><small>REF</small></th>
                                <th><small>WILL</small></th>
                                <th><small>Levels</small></th>
                            </tr>
                        </thead>
                        <tbody>
                            <ClassRow {...props} name="class1" val={props.class1} />
                            <ClassRow {...props} name="class2" val={props.class2} />
                            <ClassRow {...props} name="class3" val={props.class3} />
                            <ClassRow {...props} name="class4" val={props.class4} />
                            <ClassRow {...props} name="class5" val={props.class5} />
                            <tr>
                                <th>Base totals</th>
                                <td></td>
                                <td>{props.getClassTypeTotal('hp')}</td>
                                <td>{props.getClassTypeTotal('bab')}</td>
                                <td>{props.getClassTypeTotal('skill')}</td>
                                <td>{props.getClassTypeTotal('fort')}</td>
                                <td>{props.getClassTypeTotal('refl')}</td>
                                <td>{props.getClassTypeTotal('will')}</td>
                                <td>{props.getClassTypeTotal('levels')}</td>
                            </tr>
                        </tbody>
                    </Table>
                );
            }

            const HPTable = compose(
                onlyUpdateForKeys(['hp', 'stat', ...CLASSES, 'rage']), pure)(HPTableImpl);
            function HPTableImpl(props) {
                const totalHP = props.getAbilityMod('CON')*props.getClassTypeTotal('levels')
                                +props.getClassTypeTotal('hp');
                return (
                    <Table condensed className="hp-table">
                    <thead>
                        <tr>
                            <th className="active"><small>HP (con*lvl+cls)</small></th>
                            <td>{totalHP}</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active hp-temporary">Temporary HP</th>
                            <td><TextField {...props} propKey={['hp','temp']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Subdual dam</th>
                            <td><TextField {...props} propKey={['hp','subdual']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Lethal dam</th>
                            <td><TextField {...props} propKey={['hp','lethal']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Current HP</th>
                            <td className="success">{
                                totalHP
                                + props.getState(['hp','temp'], 0)
                                - props.getState(['hp','subdual'], 0)
                                - props.getState(['hp','lethal'], 0)
                                }</td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }

            const InitTable = compose(
                onlyUpdateForKeys(['init', 'stat']), pure)(InitTableImpl);
            function InitTableImpl(props) {
                const initTotal = props.getAbilityMod('DEX')
                    + props.getState(['init','enh'],0)
                    + props.getState(['init','misc'],0)
                    + props.getState(['init','temp'],0);
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th></th>
                            <th><small>Total</small></th>
                            <th><small>Base</small></th>
                            <th><small>Enhance</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active">Init</th>
                            <th className="success">{initTotal}</th>
                            <td>{props.getAbilityMod('DEX')}</td>
                            <td><TextField {...props} propKey={['init','enh']} /></td>
                            <td><TextField {...props} propKey={['init','misc']} /></td>
                            <td><TextField {...props} propKey={['init','temp']} /></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }

            const ResistanceTable = compose(
                onlyUpdateForKeys(['info']), pure)(ResistanceTableImpl);
            function ResistanceTableImpl(props) {
                return (
                    <Table condensed>
                    <tbody>
                        <tr>
                            <th className="active">DR</th>
                            <td><TextField {...props} propKey={['info','dr']} /></td>
                            <th className="active">SR</th>
                            <td><TextField {...props} propKey={['info','sr']} /></td>
                        </tr>
                        <tr>
                            <th className="active">Resists</th>
                            <td colSpan="3"><TextField {...props} propKey={['info','resists']} /></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }

            const SpeedTable = compose(
                onlyUpdateForKeys(['speed']), pure)(SpeedTableImpl);
            function SpeedTableImpl(props) {
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th></th>
                            <th><small>Land</small></th>
                            <th><small>w/&nbsp;armor</small></th>
                            <th><small>Swim</small></th>
                            <th><small>Climb</small></th>
                            <th><small>Fly</small></th>
                            <th><small>Fly&nbsp;manu.</small></th>
                            <th><small>Burrow</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active">Speed</th>
                            <td><TextField {...props} propKey={['speed','land']} /></td>
                            <td><TextField {...props} propKey={['speed','armored']} /></td>
                            <td><TextField {...props} propKey={['speed','swim']} /></td>
                            <td><TextField {...props} propKey={['speed','climb']} /></td>
                            <td><TextField {...props} propKey={['speed','fly']} /></td>
                            <td><TextField {...props} propKey={['speed','fly-manu']} /></td>
                            <td><TextField {...props} propKey={['speed','burrow']} /></td>
                            <td><TextField {...props} propKey={['speed','misc']} /></td>
                            <td><TextField {...props} propKey={['speed','temp']} /></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }

            const ACTable = compose(
                onlyUpdateForKeys(['stat','armor','shield','ac','rage']), pure)(ACTableImpl);
            function ACTableImpl(props) {
                const raging = props.getState(['rage','enable'],false);
                const rageBonus = raging ? getRageState(props)['ac'] : 0;
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th><small>Defence</small></th>
                            <th><small>Total</small></th>
                            <th className="hidden-xs"></th>
                            <th><small>Armor</small></th>
                            <th><small>Shield</small></th>
                            <th><small>Dex</small></th>
                            <th><small>Size</small></th>
                            <th><small>Dodge</small></th>
                            <th><small>Natural</small></th>
                            <th><small>Deflect</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                            <th className={raging?"":"hidden"}><small>Rage</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active">AC</th>
                            <th className="success">
                                {10
                                +props.getState(['armor','ac'],0)
                                +props.getState(['shield','ac'],0)
                                +props.getArmorLimitedDex()
                                +props.getState(['stat','size'],0)
                                +props.getState(['ac','dodge'],0)
                                +props.getState(['ac','natural'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','ac-misc'],0)
                                +props.getState(['ac','temp'],0)
                                +rageBonus}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>{props.getState(['armor','ac'],'')}</td>
                            <td>{props.getState(['shield','ac'],'')}</td>
                            <td>{props.getArmorLimitedDex()}</td>
                            <td>{props.getState(['stat','size'],'')}</td>
                            <td><TextField {...props} propKey={['ac','dodge']} /></td>
                            <td><TextField {...props} propKey={['ac','natural']} /></td>
                            <td><TextField {...props} propKey={['ac','deflect']} /></td>
                            <td><TextField {...props} propKey={['ac','ac-misc']} /></td>
                            <td><TextField {...props} propKey={['ac','temp']} /></td>
                            <td className={raging?"":"hidden"}><small>{rageBonus}</small></td>
                        </tr>
                        <tr>
                            <th className="active">Touch</th>
                            <th className="success">
                                {10+props.getArmorLimitedDex()
                                +props.getState(['stat','size'],0)
                                +props.getState(['ac','dodge'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','touch-misc'],0)
                                +props.getState(['ac','temp'],0)
                                +rageBonus}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>-</td>
                            <td>-</td>
                            <td>{props.getArmorLimitedDex()}</td>
                            <td>{props.getState(['stat','size'],'')}</td>
                            <td>{props.getState(['ac','dodge'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['ac','deflect'],'')}</td>
                            <td><TextField {...props} propKey={['ac','touch-misc']} /></td>
                            <td>{props.getState(['ac','temp'],'')}</td>
                            <td className={raging?"":"hidden"}><small>{rageBonus}</small></td>
                        </tr>
                        <tr>
                            <th className="active">Flat-foot</th>
                            <th className="success">
                                {10
                                +props.getState(['armor','ac'],0)
                                +props.getState(['shield','ac'],0)
                                +props.getState(['stat','size'],0)
                                +props.getState(['ac','natural'],0)
                                +props.getState(['ac','deflect'],0)
                                +props.getState(['ac','ff-misc'],0)
                                +props.getState(['ac','temp'],0)
                                +rageBonus}
                            </th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>{props.getState(['armor','ac'],'')}</td>
                            <td>{props.getState(['shield','ac'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['stat','size'],'')}</td>
                            <td>-</td>
                            <td>{props.getState(['ac','natural'],'')}</td>
                            <td>{props.getState(['ac','deflect'],'')}</td>
                            <td><TextField {...props} propKey={['ac','ff-misc']} /></td>
                            <td>{props.getState(['ac','temp'],'')}</td>
                            <td className={raging?"":"hidden"}><small>{rageBonus}</small></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }

            function SaveTableRow(props) {
                const raging = props.getState(['rage','enable'],false);
                const rageBonus = raging ? getRageState(props)[props.save] || 0 : 0;
                return (
                    <tr>
                        <th className="active">{props.save.toUpperCase()}</th>
                        <th className="success">{
                            props.getClassTypeTotal(props.save)
                            +props.getAbilityMod(props.ability)
                            +props.getState([props.save,'enhance'],0)
                            +props.getState([props.save,'misc'],0)
                            +props.getState([props.save,'temp'],0)
                            +rageBonus }</th>
                        <td>{props.getClassTypeTotal(props.save)}</td>
                        <td>{props.getAbilityMod(props.ability)}</td>
                        <td><TextField {...props} propKey={[props.save,'enhance']}/></td>
                        <td><TextField {...props} propKey={[props.save,'misc']}/></td>
                        <td><TextField {...props} propKey={[props.save,'temp']}/></td>
                        <td className={raging?"":"hidden"}><small>{rageBonus||""}</small></td>
                    </tr>
                );
            }

            const SaveTable = compose(
                onlyUpdateForKeys([...SAVES,'stat',...CLASSES,'rage']), pure)(SaveTableImpl);
            function SaveTableImpl(props) {
                const raging = props.getState(['rage','enable'],false);
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th className="save-name">
                                <small>Save</small>
                            </th>
                            <th><small>Total</small></th>
                            <th><small><span className="hidden-xs">Class </span>base</small></th>
                            <th><small>Abil<span className="hidden-xs">ity</span></small></th>
                            <th><small>Enh<span className="hidden-xs">ance</span></small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                            <th className={raging?"":"hidden"}><small>Rage</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <SaveTableRow {...props} save="fort" ability="CON"/>
                        <SaveTableRow {...props} save="refl" ability="DEX"/>
                        <SaveTableRow {...props} save="will" ability="WIS"/>
                    </tbody>
                    </Table>
                );
            }

            const AttackTable = compose(
                onlyUpdateForKeys([...CLASSES, 'stat','rage','melee','ranged','cmb','cmd']),
                pure )( AttackTableImpl );
            function AttackTableImpl(props) {
                const strMod = props.getAbilityMod('STR');
                const dexMod = props.getAbilityMod('DEX');
                const sizeMod = props.getState(['stat','size'],0);
                const cmbAbilityMod = sizeMod < 2 ? strMod : dexMod;
                const attackRows = [
                        {name: 'melee', ability: strMod, size: sizeMod}
                        ,{name: 'ranged', ability: dexMod, size: sizeMod}
                    ].map( attack =>
                        <tr>
                            <th className="active">{attack['name'].toUpperCase()}</th>
                            <th className="success">
                                { props.getClassTypeTotal('bab')
                                + attack['ability']
                                + attack['size']
                                + props.getState([attack['name'],'misc'],0)
                                + props.getState([attack['name'],'temp'],0)
                            }</th>
                            <td className="hidden-xs"></td>
                            <td>{props.getClassTypeTotal('bab')}</td>
                            <td>{attack['ability']}</td>
                            <td>{attack['size']}</td>
                            <td><TextField {...props} propKey={[attack['name'],'misc']}/></td>
                            <td><TextField {...props} propKey={[attack['name'],'temp']}/></td>
                        </tr>
                    );
                return (
                    <Table condensed>
                    <thead>
                        <tr>
                            <th className="attack-name">
                                <small>Attack</small>
                            </th>
                            <th><small>Total</small></th>
                            <th className="hidden-xs"></th>
                            <th><small>BAB</small></th>
                            <th><small>Abil<span className="hidden-xs">ity</span></small></th>
                            <th><small>Size</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        {attackRows}
                        <tr>
                            <th className="active">CMB</th>
                            <th className="success">
                                {
                                props.getClassTypeTotal('bab')
                                + cmbAbilityMod
                                - sizeMod
                                + props.getState(['cmb','misc'],0)
                                + props.getState(['cmb','temp'],0)
                            }</th>
                            <td className="hidden-xs"></td>
                            <td>{props.getClassTypeTotal('bab')}</td>
                            <td><NoPrintAbbr title="STR for small and larger, DEX for tiny and smaller. Use the misc modifier to adjust for the Agile Maneuvers feat.">{cmbAbilityMod}</NoPrintAbbr></td>
                            <td><NoPrintAbbr title="*special* size modifier">{-sizeMod}</NoPrintAbbr></td>
                            <td><TextField {...props} propKey={['cmb','misc']}/></td>
                            <td><TextField {...props} propKey={['cmb','temp']}/></td>
                        </tr>
                        <tr>
                            <th className="active">CMD</th>
                            <th className="success">
                                { 10
                                + props.getClassTypeTotal('bab')
                                + strMod + dexMod
                                + props.getState(['ac','dodge'],0)
                                + props.getState(['ac','deflect'],0)
                                - sizeMod
                                + props.getState(['cmd','misc'],0)
                                + props.getState(['cmd','temp'],0)
                            }</th>
                            <td className="hidden-xs"><small>10+</small></td>
                            <td>{props.getClassTypeTotal('bab')}</td>
                            <td><NoPrintAbbr title="STR+DEX+dodge+deflect">
                                    {
                                    strMod + dexMod
                                    + props.getState(['ac','dodge'],0)
                                    + props.getState(['ac','deflect'],0)
                                    }</NoPrintAbbr></td>
                            <td><NoPrintAbbr title="*special* size modifier">{-sizeMod}</NoPrintAbbr></td>
                            <td><NoPrintAbbr title="Add here any insight, luck, morale, profane, and sacred bonuses to AC"><TextField {...props} propKey={['cmd','misc']}/></NoPrintAbbr></td>
                            <td><TextField {...props} propKey={['cmd','temp']}/></td>
                        </tr>
                    </tbody>
                    </Table>
                );
            }

            function ArmorTable(props) {
                const armorKeys = ['ac','max-dex','skill-penalty',
                    'spell-fail','type','weight'];
                const armorControls = armorKeys.map( (key) =>
                    <td><TextField {...props} propKey={['armor',key]} /></td>
                );
                const shieldControls = armorKeys.map( (key) =>
                    <td><TextField {...props} propKey={['shield',key]} /></td>
                );
                return (
                    <Table condensed className="armor-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th className="armor-name">
                                <small>Armor name & description</small>
                            </th>
                            <th><small>AC Bonus</small></th>
                            <th><small>Max Dex</small></th>
                            <th><small>Check penalty</small></th>
                            <th><small>Spell fail</small></th>
                            <th><small>Type</small></th>
                            <th><small>Weight</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th className="active"><small>Armor</small></th>
                            <td><NoteArea {...props} propKey={['armor','desc']}
                                placeholder="armor note" onerow /></td>
                            {armorControls}
                        </tr>
                        <tr>
                            <th className="active"><small>Shield</small></th>
                            <td><NoteArea {...props} propKey={['shield','desc']}
                                placeholder="shield note" onerow /></td>
                            {shieldControls}
                        </tr>
                    </tbody>
                    </Table>
                );
            }

            const WeaponTable = compose(
                onlyUpdateForKeys(WEAPONS), pure)(WeaponTableImpl);
            function WeaponTableImpl(props) {
                const weaponKeys = ['bonus','dmg','crit',
                    'range','type','weight'];
                let weaponRows = [];
                for( var i = 0; i<20; i++) {
                    if ( i>0 && isEmpty( props.getState(['weapon'+(i-1)])) ) break;
                    const cells = weaponKeys.map( (key) =>
                        <td><TextField {...props} propKey={['weapon'+i,key]} /></td>
                    );
                    const row = <tr>
                        <td><NoteArea {...props} propKey={['weapon'+i,'desc']}
                                placeholder="name" onerow /></td>
                        {cells}
                        <td><NoteArea {...props} propKey={['weapon'+i,'note']}
                                placeholder="notes" onerow /></td>
                    </tr>;
                    weaponRows = [...weaponRows,row];
                }
                return (
                    <Table condensed className="weapon-table">
                    <thead>
                        <tr>
                            <th className="weapon-name">
                                <small>Weapon name & description</small>
                            </th>
                            <th className="weapon-bonus"><small>Attack bonus</small></th>
                            <th className="weapon-damage"><small>Damage</small></th>
                            <th className="weapon-critical"><small>Critical</small></th>
                            <th className="weapon-range"><small>Range</small></th>
                            <th className="weapon-type"><small>Type</small></th>
                            <th className="weapon-weight"><small>Weight</small></th>
                            <th><small>Notes & ammo</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        {weaponRows}
                    </tbody>
                    </Table>
                );
            }

            function CheckboxField(props) {
                const {propKey} = props;
                return (
                    <FormGroup controlId={propKey.join('-')}>
                        <Checkbox inline
                            checked={props.getState(propKey)}
                            onChange={props.handleChange(propKey)}>
                            {props.children}
                        </Checkbox>
                    </FormGroup>
                );
            }
            function SelectField(props) {
                const {propKey, options} = props;
                const currVal = props.getState(propKey);
                const emptyOption = options.indexOf(currVal) > -1 ? "" : <option />
                const optionList = options.map( (option,index) =>
                    <option value={option}>{option}</option> );
                return (
                    <FormGroup controlId={propKey.join('-')} bsSize={props.bsSize||"sm"}>
                        <FormControl componentClass="select"
                            placeholder={props.getState(propKey)}
                            value={props.getState(propKey)}
                            onChange={props.handleChange(propKey)}>
                        {emptyOption}
                        {optionList}
                        </FormControl>
                    </FormGroup>
                );
            }

            const SKILL_AC_PENALTY_ABILITIES = ['STR','DEX'];
            function CustomSkillRow(props) {
                const {propKey} = props;
                const abilityKey = [...propKey,'ability'];
                const ability = props.getState(abilityKey);
                const hasAcPenalty = SKILL_AC_PENALTY_ABILITIES.indexOf(ability) > -1;
                const nameField = <span>
                    <TextField {...props} propKey={[...propKey,'categ']} />
                    {hasAcPenalty ? "*" : ""}
                    </span>;
                const abilityField = <SelectField {...props} propKey={abilityKey} options={STATS} />;
                const empty = isEmpty(props.getState([...propKey,'categ'],{}));
                return (<SkillRowBase {...props} nameField={nameField} ability={ability}
                abilityField={abilityField} hasAcPenalty={hasAcPenalty} empty={empty} />);
            }
            function SkillRow(props) {
                const {propKey,name,ability,hasCategory} = props;
                const hasAcPenalty = SKILL_AC_PENALTY_ABILITIES.indexOf(ability) > -1;
                const dispName = name + (hasAcPenalty ? '*': '') + (hasCategory ? ': ': '');
                const categoryField = hasCategory
                        ? <TextField {...props} propKey={[...propKey,'categ']}/>
                        : "";
                const nameField = <span>{dispName}{categoryField}</span>;
                return (<SkillRowBase {...props} nameField={nameField} ability={ability}
                    abilityField={ability} hasAcPenalty={hasAcPenalty} />);
            }

            function SkillRowBase(props) {
                const {propKey,nameField,ability,abilityField,hasAcPenalty,isUntrainedUse,empty} = props;
                const ranks = props.getState([...propKey,'ranks']);
                const isClass = props.getState([...propKey,'is-class']);
                return (<tr>
                    <td className="skill-name">
                        <CheckboxField {...props} propKey={[...propKey,'is-class']}>
                        <small>{nameField}</small></CheckboxField></td>
                    <td className="skill-ability"><small>{empty?'':abilityField}</small></td>
                    <th className="success"><small>{
                        isUntrainedUse || ranks !== undefined ?
                            props.getState([...propKey,'ranks'],0)
                            + props.getAbilityMod(ability)
                            + (ranks>0 && isClass ? 3 : 0)
                            + props.getState([...propKey,'misc'],0)
                            + props.getState([...propKey,'temp'],0)
                            - (hasAcPenalty ? props.getState(['armor','skill-penalty'],0)
                                + props.getState(['shield','skill-penalty'],0) : 0 )
                        : ""
                            }</small></th>
                    <td><small><TextField {...props} propKey={[...propKey,'ranks']}/></small></td>
                    <td><small>{empty?'':props.getAbilityMod(ability)}</small></td>
                    <td><small>{ranks>0 && isClass ? 3 : 0}</small></td>
                    <td><small><TextField {...props} propKey={[...propKey,'misc']}/></small></td>
                    <td><small><TextField {...props} propKey={[...propKey,'temp']}/></small></td>
                </tr>);
            }

            const SkillTable = compose(
                onlyUpdateForKeys(['skill', 'stat', 'armor', 'shield', ...CLASSES]),
                pure)(SkillTableImpl);
            function SkillTableImpl(props) {
                const SKILL_ABILITIES = ['DEX', 'INT', 'CHA', 'STR', 'INT', 'CHA',
                    'DEX', 'CHA', 'DEX', 'DEX', 'CHA', 'WIS', 'CHA', 'INT', 'INT',
                    'WIS', 'CHA', 'WIS', 'DEX', 'WIS', 'DEX', 'INT', 'DEX', 'WIS',
                    'STR', 'CHA', ''];
                const SKILL_NAMES = ['Acrobatics', 'Appraise', 'Bluff', 'Climb',
                    'Craft', 'Diplomacy', 'Disable Device', 'Disguise',
                    'Escape Artist', 'Fly', 'Handle Animal', 'Heal', 'Intimidate',
                    'Kn', 'Linguistics', 'Perception', 'Perf', 'Prof', 'Ride',
                    'Sense Motive', 'Sleight of Hand', 'Spellcraft', 'Stealth',
                    'Survival', 'Swim', 'Use Magic Device' ];
                const SKILLS_UNTRAINED_USE = [
                    'Skill' ,'Acrobatics' ,'Appraise' ,'Bluff' ,'Climb' ,'Craft'
                    ,'Diplomacy' ,'Disguise' ,'Escape Artist' ,'Fly' ,'Heal'
                    ,'Intimidate' ,'Perception' ,'Perf' ,'Ride' ,'Sense Motive'
                    ,'Stealth' ,'Survival' ,'Swim' ];
                const CATEGORY_SKILLS = ['Craft','Kn','Perf','Prof'];
                const skillRows = SKILL_NAMES.reduce( (rows, name, i) => {
                    const hasCategory = CATEGORY_SKILLS.indexOf(name) > -1;
                    const isUntrainedUse = SKILLS_UNTRAINED_USE.indexOf(name) > -1;
                    if (!hasCategory) {
                        rows=rows.concat(<SkillRow {...props} name={name}
                            propKey={['skill',name.toLowerCase()]}
                            isUntrainedUse={isUntrainedUse}
                            ability={SKILL_ABILITIES[i]} hasCategory={hasCategory}/>);
                        return rows;
                    }
                    for( let categoryIndex = 0; categoryIndex < 10; categoryIndex++ ) {
                        const propKey = ['skill',name.toLowerCase()+categoryIndex];
                        const prevKey = ['skill',name.toLowerCase()+(categoryIndex-1)];
                        if( categoryIndex>0
                                && isEmpty(props.getState(prevKey,{}))
                                && isEmpty(props.getState(propKey,{})) ) {
                            continue;
                        }
                        rows=rows.concat(<SkillRow {...props} name={name} propKey={propKey}
                            isUntrainedUse={isUntrainedUse}
                            ability={SKILL_ABILITIES[i]} hasCategory={hasCategory}/>);
                    }
                    return rows;
                }, []);
                let customSkillRows = [];
                for( let categoryIndex = 0; categoryIndex < 10; categoryIndex++ ) {
                    const propKey = ['skill','custom'+categoryIndex];
                    const prevKey = ['skill','custom'+(categoryIndex-1)];
                    if( categoryIndex>0
                            && isEmpty(props.getState([...prevKey,'categ'],{}))
                            && isEmpty(props.getState(propKey,{})) ) {
                        continue;
                    }
                    customSkillRows=customSkillRows.concat(
                        <CustomSkillRow {...props} propKey={propKey} />);
                }
                const totalSkillRanks = props.getClassTypeTotal('skill');
                const assignedSkillRanks = props.skill &&
                    Object.keys(props.skill).reduce( (sum, skill) =>
                        ( sum+props.getState(['skill',skill,'ranks'],0)), 0);
                const unassignedSkillRanks = totalSkillRanks - assignedSkillRanks;
                const unassignedLabel = " (unused ranks "+unassignedSkillRanks+")";
                return (
                    <Table striped condensed className="skill-table">
                    <thead>
                        <tr>
                            <th className="skill-name" colSpan={2}>
                                <small>Skill{unassignedLabel}</small>
                            </th>
                            <th><small>Total</small></th>
                            <th><small>Ranks</small></th>
                            <th><small>Abil</small></th>
                            <th><small>Trai</small></th>
                            <th><small>Misc</small></th>
                            <th><small>Temp</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        {skillRows}
                        {customSkillRows}
                    </tbody>
                    </Table>
                );
            }

            function getRageState(props) {
                const rageLevel = props.getState(['rage','level'])
                return rageLevel>19 ? {header:'Mighty Rage', STR: 8, CON: 8, will: 4, ac: -2} :
                    rageLevel>10 ? {header:'Greater Rage', STR: 6, CON: 6, will: 3, ac: -2} :
                    {header:'Rage', STR: 4, CON: 4, will: 2, ac: -2};
            }

            function EquipmentTable(props) {
                let equipmentRows = [];
                for( let i = 0; i < 50; i++ ) {
                    const propKey = ['eq',''+i];
                    const prevKey = ['eq',''+(i-1)];
                    if( i>0 && isEmpty(props.getState(prevKey,{}))
                            && isEmpty(props.getState(propKey,{})) ) {
                        continue;
                    }
                    equipmentRows=equipmentRows.concat(
                        <EquipmentRow {...props} propKey={propKey} />);
                }
                return (
                    <Table condensed className="equipment-table">
                    <thead>
                        <tr>
                            <th className="equipment-name"><small>Equipment name & description</small></th>
                            <th><small>Value</small></th>
                            <th><small>Weight</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        {equipmentRows}
                    </tbody>
                    </Table>
                );
            }

            function EquipmentRow(props) {
                const {propKey} = props;
                return (<tr>
                    <td><small><NoteArea {...props} placeholder="name note" propKey={[...propKey,'name']} onerow/></small></td>
                    <td><small><TextField {...props} propKey={[...propKey,'value']}/></small></td>
                    <td><small><TextField {...props} propKey={[...propKey,'weight']}/></small></td>
                </tr>);
            }

            const RagePanel = compose(
                onlyUpdateForKeys(['rage', 'stat', 'note']),
                pure)(RagePanelImpl);
            function RagePanelImpl(props) {
                if( !props.getState(['rage']) ) {
                    return <span />;
                }
                const rageLevel = props.getState(['rage','level'])
                const rageRounds = 2 + 2 * rageLevel
                    + props.getAbilityMod('CON',true)
                    + props.getState(['rage','rounds','misc'],0)
                    - props.getState(['rage','rounds','used'],0)
                const rageState = getRageState(props);
                const headerCheckbox =
                    <CheckboxField {...props} propKey={['rage','enable']}>
                        {rageState.header}
                    </CheckboxField>;
                const validationRageEnabled = props.getState(['rage','enable'],false) ? "success" : "";
                // console.debug( 'validationRageEnabled', validationRageEnabled, props.getState(['rage','enable'],false) );
                return (
                    <Panel header={headerCheckbox}>
                        <Row>
                        <Col sm={8}>
                            <Row>
                                <ColTextField {...props} label="Class levels" propKey={['rage','level']} xs={3} />
                                <ColTextField {...props} label="Misc rounds" propKey={['rage','rounds','misc']} xs={3} />
                                <ColTextField {...props} label="Used rounds" validationState="warning" propKey={['rage','rounds','used']} xs={3} />
                                <ColText label="Rounds of rage left" validationState="success" xs={3} >{rageRounds}</ColText>
                            </Row>
                            <Row>
                            <ColText label="STR bonus" validationState={validationRageEnabled} xs={3} >{rageState.STR}</ColText>
                            <ColText label="CON bonus" validationState={validationRageEnabled} xs={3} >{rageState.CON}</ColText>
                            <ColText label="Will bonus" validationState={validationRageEnabled} xs={3} >{rageState.will}</ColText>
                            <ColText label="AC penalty" validationState={validationRageEnabled} xs={3} >{rageState.ac}</ColText>
                            </Row>
                        </Col>
                        <Col sm={4}>
                            <NoteArea {...props} noteKey="rage" val={props.note.rage} />
                        </Col>
                        </Row>
                    </Panel>
                );
            }

            function SpellTablePanel(props) {
                const propKey = 'spell1';
                if( !props.getState([propKey]) ) {
                    return <span />;
                }
                const headerClassTextField =
                    <Table condensed className="spells-header-table">
                    <thead>
                        <tr>
                        <td>Spellcaster class:</td>
                        <td><TextField {...props} bsSize="sm" propKey={[propKey,'className']}/></td>
                        <td>Level:</td>
                        <td><TextField {...props} bsSize="sm" propKey={[propKey,'level']}/></td>
                        <td>Ability:</td>
                        <td><SelectField {...props} propKey={[propKey,'ability']} options={STATS} /></td>
                        </tr>
                    </thead>
                    </Table>
                const rows = [0,1,2,3,4,5,6,7,8,9].map( function(i) {
                    if( i>0 && props.getState([propKey,'l'+(i-1),'class']) === undefined ) return;
                    const hideLast = props.getState([propKey,'l'+(i),'class']) === undefined?'hidden':'';
                    const abilityMod = props.getAbilityMod( props.getState([propKey,'ability']), true );
                    const abilityBonus = i==0 ? 0 : abilityMod;
                    return <tr>
                            <td className="active">{i}</td>
                            <td><TextField {...props} className={hideLast}
                                propKey={[propKey,'l'+i,'known']}/></td>
                            <td><TextField {...props} className={hideLast} propKey={[propKey,'l'+i,'dc']}
                                placeholder={10+i+abilityMod} /></td>
                            <td className="success">{
                                props.getState([propKey,'l'+i,'class']) === undefined ? "" :
                                ['class','misc'].reduce( function(sum, key) {
                                    return sum + props.getState([propKey,'l'+i,key],0);
                                }, 0)
                                + abilityBonus
                                - props.getState([propKey,'l'+i,'used'],0)
                                }</td>
                            <td><TextField {...props} propKey={[propKey,'l'+i,'class']}/></td>
                            <td>{hideLast?'':abilityBonus||''}</td>
                            <td><TextField {...props} className={hideLast}
                                propKey={[propKey,'l'+i,'misc']}/></td>
                            <td className="warning"><TextField {...props} className={hideLast}
                                propKey={[propKey,'l'+i,'used']}/></td>
                        </tr>
                    });
                return (
                    <Panel header={headerClassTextField}>
                        <Row>
                        <Col sm={6}>
                            <Table condensed className="spells-table">
                            <thead>
                                <tr>
                                    <th><small>Spell Level</small></th>
                                    <th><small>#Spells known</small></th>
                                    <th><small>Save DC</small></th>
                                    <th><small>Spells remaining</small></th>
                                    <th><small>Class daily #</small></th>
                                    <th><small>Ability bonus</small></th>
                                    <th><small>Misc bonus</small></th>
                                    <th><small>Used</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                {rows}
                            </tbody>
                            </Table>
                        </Col>
                        <Col sm={6}>
                            <Table condensed className="spellRange-table">
                            <thead>
                                <tr>
                                    <td><small></small></td>
                                    <td><small>Close</small></td>
                                    <td><small>Medium</small></td>
                                    <td><small>Long</small></td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th className="active"><small>Range(ft)</small></th>
                                    <td className="success">
                                        {25+5*Math.floor(props.getState([propKey,'level'])/2)}</td>
                                    <td className="success">
                                        {100+10*props.getState([propKey,'level'])}</td>
                                    <td className="success">
                                        {400+40*props.getState([propKey,'level'])}</td>
                                </tr>
                            </tbody>
                            </Table>
                            <NoteArea {...props} placeholder="Specialty, domain, familiar, etc. notes"
                                noteKey={propKey} val={props.note[propKey]} />
                        </Col>
                        </Row>
                        TODO: autogrowing spell list (up to spells known)
                    </Panel>
                );
            }

            const AddfieldsNavbar = compose(
                onlyUpdateForKeys(['debug', 'react_perf']),
                pure)(AddfieldsNavbarImpl);
            function AddfieldsNavbarImpl(props) {
                function clearTemp(e) {
                    console.log( 'clearTemp' );
                }
                function clearTempSubdual(e) {
                    clearTemp(e);
                    console.log( 'clearSubdual' );
                }
                function clearUses(e) {
                    console.log( 'clearUses' );
                }
                function clearUsesDamage(e) {
                    clearUses(e);
                    console.log( 'clearDamage' );
                }
                return (
                    <Navbar fluid>
                        <Nav>
                            <NavDropdown dropup title="TODO: Clear...">
                                <MenuItem onSelect={clearTemp}>Temporary bonuses</MenuItem>
                                <MenuItem onSelect={clearTempSubdual}>Temporary bonuses and subdual damage</MenuItem>
                                <MenuItem onSelect={clearUses}>Uses per day</MenuItem>
                                <MenuItem onSelect={clearUsesDamage}>Uses per day and all damage</MenuItem>
                            </NavDropdown>
                        </Nav>
                        <Nav>
                            <NavDropdown dropup title="Add fields for...">
                                <MenuItem onSelect={props.handleChange(['rage'],Object)}>Rage</MenuItem>
                                <MenuItem onSelect={props.handleChange(['spell1'],Object)}>Spellcaster class and spell list</MenuItem>
                                <MenuItem>TODO:Spell like ability list</MenuItem>
                            </NavDropdown>
                        </Nav>
                        <Nav pullRight>
                            <NavDropdown pullRight dropup title={<small>Debug</small>}>
                                <MenuItem onSelect={props.handleChange(['debug'],invert)}>
                                    <Checkbox checked={props.getState(['debug'],false)}>
                                        console debug
                                    </Checkbox>
                                </MenuItem>
                                <MenuItem onSelect={props.handleChange(['react_perf'],invert)}>
                                    <Checkbox checked={props.getState(['react_perf'],false)}>
                                        react_perf
                                    </Checkbox>
                                </MenuItem>
                            </NavDropdown>
                        </Nav>
                    </Navbar>
                );
            }

            function invert(v) {
                return (!!v) ? undefined : true;
            }

        </script>

        <script type="text/javascript">
            function isEmpty(object) {
                return object == null ||
                    typeof(object) === 'object' && Object.keys(object).length == 0;
            }
            var autoresizeFields = [];
            function addAutoresize(inputRef) {
                autoresizeFields.push( inputRef );
                inputRef.addEventListener('input', function(e) { autoresize_update(e.target) }, false);
                autoresize_update( inputRef );
            }
            function autoresizeAll() {
                console.debug( 'autoresizeAll' );
                autoresizeFields.forEach( autoresize_update );
            }
            function autoresize_update( inputRef ) {
                // console.log('autoresize_update',inputRef, inputRef.scrollHeight);
                inputRef.style.height = '';
                inputRef.style.height = inputRef.scrollHeight+'px';
                //inputRef.scrollTop = inputRef.scrollHeight;
                //window.scrollTo(window.scrollLeft,(inputRef.scrollTop+inputRef.scrollHeight));
            }
            // Polyfill
            if (!Array.isArray) {
                Array.isArray = function(arg) {
                    return Object.prototype.toString.call(arg) === '[object Array]';
                };
            }
        </script>
    </head>
    <body>
        <div id="root">Failed to load? :(</div>
        <script type="text/babel">
            ReactDOM.render( <App />, document.getElementById('root'));
        </script>
    </body>
</html>
